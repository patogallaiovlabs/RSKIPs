<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>Bridge UTXOs Coin Selection | RSK Improvement Proposals</title>
    <meta
      property="og:title"
      content="Bridge UTXOs Coin Selection | RSK Improvement Proposals"
    />
    <meta name="description" content="RSK Improvement Proposals (RSKIPs) describe standards for the RSK platform, including core protocol specifications, client APIs, and contract standards." />
    <meta property="og:description" content="RSK Improvement Proposals (RSKIPs) describe standards for the RSK platform, including core protocol specifications, client APIs, and contract standards." />
    <meta name="twitter:description" content="RSK Improvement Proposals (RSKIPs) describe standards for the RSK platform, including core protocol specifications, client APIs, and contract standards." />

  <meta name="generator" content="Jekyll" />
  <meta property="og:locale" content="en_US" />
  <link rel="canonical" href="https://ips.rsk.co/IPs/RSKIP265.html" />
  <meta property="og:url" content="https://ips.rsk.co/IPs/RSKIP265.html" />
  <meta property="og:site_name" content="RSK Improvement Proposals" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@" />
  <script type="application/ld+json">
    {
      "@type": "WebSite",
      "url": "https://ips.rsk.co",
      "name": "RSK Improvement Proposals",
      "description": "RSK Improvement Proposals (RSKIPs) describe standards for the RSK platform, including core protocol specifications, client APIs, and contract standards.",
      "@context": "https://schema.org"
    }
  </script>
  <link rel="stylesheet" href="/assets/css/style.css" />
      <!-- Google Fonts -->
      <link href="https://fonts.googleapis.com/css?family=Quicksand:400,700,900&display=swap" rel="stylesheet">
      <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,600,700,800&display=swap" rel="stylesheet"><link type="application/atom+xml" rel="alternate" href="https://ips.rsk.co/pages/rsksmart/rskips/feed.xml" title="RSK Improvement Proposals" /><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML" integrity="sha256-nlrDrBTHxJJlDDX22AS33xYI1OJHnGMDhiYMSe2U0e0=" crossorigin="anonymous"></script>
</head>
<body><header class="site-header" role="banner">
  <button id="dark-mode-toggle" class="dark-mode-toggle theme-toggle-button">
    <svg class="icon" style="width:24px;height:24px" viewBox="0 0 24 24">
      <path fill="currentColor" d="M7.5,2C5.71,3.15 4.5,5.18 4.5,7.5C4.5,9.82 5.71,11.85 7.53,13C4.46,13 2,10.54 2,7.5A5.5,5.5 0 0,1 7.5,2M19.07,3.5L20.5,4.93L4.93,20.5L3.5,19.07L19.07,3.5M12.89,5.93L11.41,5L9.97,6L10.39,4.3L9,3.24L10.75,3.12L11.33,1.47L12,3.1L13.73,3.13L12.38,4.26L12.89,5.93M9.59,9.54L8.43,8.81L7.31,9.59L7.65,8.27L6.56,7.44L7.92,7.35L8.37,6.06L8.88,7.33L10.24,7.36L9.19,8.23L9.59,9.54M19,13.5A5.5,5.5 0 0,1 13.5,19C12.28,19 11.15,18.6 10.24,17.93L17.93,10.24C18.6,11.15 19,12.28 19,13.5M14.6,20.08L17.37,18.93L17.13,22.28L14.6,20.08M18.93,17.38L20.08,14.61L22.28,17.15L18.93,17.38M20.08,12.42L18.94,9.64L22.28,9.88L20.08,12.42M9.63,18.93L12.4,20.08L9.87,22.27L9.63,18.93Z" />
    </svg>
  </button>


<div class="wrapper"><a class="site-title" rel="author" href="/">RSK Improvement Proposals</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link underline" href="/all.html">All</a><a class="page-link underline" href="/scalability.html">Scalability</a><a class="page-link underline" href="/security.html">Security</a><a class="page-link underline" href="/usability.html">Usability</a><a class="page-link underline" href="/fairness.html">Fairness</a><a class="page-link underline" href="/standardtrack.html">Standard Track</a></div>





      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post">

  <header class="post-header">
    <h1 class="post-title">Bridge UTXOs Coin Selection</h1>
  </header>

  <div class="post-content">
    <h1 id="bridge-utxos-coin-selection">Bridge UTXOs Coin Selection</h1>

<table>
  <thead>
    <tr>
      <th style="text-align: left">RSKIP</th>
      <th style="text-align: left">265</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left"><strong>Title</strong></td>
      <td style="text-align: left">Bridge UTXOs Coin Selection</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Created</strong></td>
      <td style="text-align: left">AUG-2021</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Author</strong></td>
      <td style="text-align: left">SDL</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Purpose</strong></td>
      <td style="text-align: left">Sec, Usa</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Layer</strong></td>
      <td style="text-align: left">Core</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Complexity</strong></td>
      <td style="text-align: left">2</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Status</strong></td>
      <td style="text-align: left">Draft</td>
    </tr>
  </tbody>
</table>

<h1 id="abstract"><strong>Abstract</strong></h1>

<p>One of the problems of the RSK bridge is that it doesn’t have any means to prevent the proliferation and fragmentation of UTXOs. This can lead to a number of cost, usability, efficiency and security problems. This RSKIP proposes new algorithm to improve the selection of UTXOs. This RSKIP also specifies specific changes when activated together with <a href="https://github.com/rsksmart/RSKIPs/blob/master/IPs/RSKIP207.md">RSKIP207</a> <a href="https://github.com/rsksmart/RSKIPs/blob/master/IPs/RSKIP264.md">RSKIP264</a>, <a href="https://github.com/rsksmart/RSKIPs/blob/master/IPs/RSKIP270.md">RSKIP270</a>, <a href="https://github.com/rsksmart/RSKIPs/blob/master/IPs/RSKIP271.md">RSKIP271</a> and <a href="https://github.com/rsksmart/RSKIPs/blob/master/IPs/RSKIP272.md">RSKIP272</a>.</p>

<h2 id="motivation">Motivation</h2>

<p>The current RSK bridge can suffer from a number of problems:</p>

<ul>
  <li><strong>Denial-of-Service</strong>: If too many peg-outs are commanded in a short timeframe, then the users may need to wait tens of hours for the funds to be available. This is because peg-out transactions require a confirmation period of approximately 37 hours and change UTXOs that were recently included in peg-outs need to be registered with the Bridge again, with requires 100 Bitcoin confirmations. Only afterward the returning change is again usable by the Bridge and new peg-outs can consume them. A more advanced attack can block the peg for longer periods by looping peg-in and peg-out transactions. This attack works because peg-outs requests are queued, so a sufficiently resourced attacker can queue enough small-valued peg-outs to block the peg. The cost of the attack is the financial cost of locked bitcoins and the bitcoin transaction fees involved.</li>
  <li><strong>UTXO proliferation</strong>: Each peg-in creates a new UTXO. Each peg-out on average consumes more UTXOs than it creates (but only slightly less). However, currently the platform receives more peg-ins than peg-outs it creates, which leads to a slow but steady proliferation of UTXOs. The only force that counteracts this proliferation is the Powpeg migration process, which consolidates all UTXOs into a single output (or a few outputs if not all inputs can be added into a single transaction). Higher number of UTXOs means that the Bridge must scan a higher number of inputs. This is  scan would be lineal if the Bridge used a greedy algorithm, but currently is worse because the Bridge sorts the UTXOs by hash (which provides no benefit at all). The UTXO proliferation leads to higher CPU and storage resource consumption. First, all UTXOs are currently loaded into memory each time a peg-out transaction needs to be built. Second, the same list of UTXOs with some UXTOs removed is written back to storage after a peg-out transaction is built. Finally, during the processes to build a peg-out transaction, the Bridge must scan all UTXOs looking for valid inputs to cover the funds to release.</li>
  <li><strong>UTXO fragmentation</strong>: Each time a peg-out occurs, an UTXO amount is sliced into two: the amount to pay to a user, and a change amount. Change amounts generally get smaller and smaller, until they are consumed or considered “dust” and they stay forever in the UTXO set. Dust outputs are UTXOs which costs more to spend them than the value they provide. Currently, if a peg-out transaction would create a dust output, this output is omitted from the transaction and the change amount is charged to the user that performs the peg-out, which leaves the dust UTXO forever in the Bridge UTXO set. Also fragmentation increases the cost of peg-out if the Bitcoin fees/kilobyte price is high at the time of peg-out. Historically, the Bitcoin transaction cost has followed Bitcoin price change (first derivative). In other words, it is high when Bitcoin price increases, but decreases when Bitcoin price does. This means that the best strategy to keep the UTXO set small is to defragment at specific times, but not necessarily to defragment it as soon as possible. The advantage of defragmenting at peg-in time (by consolidating the recently received UTXO with a preexisting one) is that the consolidation cost can be transferred to the user that chose to perform the peg-in and the cost is bounded because the number of inputs in the consolidation transaction can be fixed at 2. When consolidation is performed at peg-out time, the number of inputs can be high if the UTXOs amount is not uniformly distributed over the common peg-out amount range. In either case, what is important is that the user can make an informed decision of what fees she will be paying for peg-in and peg-out, and it is much easier to estimate input consolidation costs at peg-in than at peg-out.</li>
  <li><strong>UTXO uneven amount distributions</strong>: if there is a peg-in transaction P of a very high amount of bitcoins, followed of a peg-out of an amount that is higher than all other UTXO amounts, yet much lower than the amount in P, then a high amount of bitcoins will be blocked for 54 hours until the change UTXO is registered again.  If more of similar peg-out operations repeat, then a high amount of bitcoins may be locked for a long period, even if decreasing in value, blocking other peg-outs. We call this the “ladder” attack. The underlying problem can also presents itself spontaneously if the normal functioning of the peg tends to produce an uneven distribution of amounts.</li>
  <li><strong>UTXO set shrink</strong>: if there are many more peg-outs than peg-ins, then the number of available UTXOs can be depleted, leading to long waits for the change amounts to be confirmed into the peg again.</li>
  <li><strong>Varying peg-out costs:</strong> peg-outs are queued, and peg-out transactions are built every 3 minutes. When that happens, peg-out fees are computed, and the user is charged accordingly by subtracting fees from their peg-out amounts. This brings two problems: 1) The user does not know the exact fee being charged in advance and 2) The exact amount to be received cannot be preestablished.</li>
  <li><strong>UTXO refresh preference</strong>: If RSKIP264 is activated, then the coin selection algorithm should prefer consuming older UTXO to avoid the need for UTXO refresh transactions.</li>
  <li><strong>Peg-out transactions fee bumping:</strong> Bitcoin mempool congestion produce spikes in Bitcoin transaction fees. Peg-outs may be left waiting in the mempool for hours or days. This not only affect the user performing the peg-out but also other future peg-out users as the Bridge cannot spend the change UTXO. RSKIP207 proposed a method for fee-bumping that requires changes in the coin selection algorithm.</li>
</ul>

<p>This RSKIP proposes a new UTXO selection algorithm that solves most of these problems with an heuristic and efficient algorithm.</p>

<h2 id="specification">Specification</h2>

<p>We describe the new coin selection algorithm. This algorithm varies if other RSKIPs are activated together with this RSKIP.</p>

<p>We define usersPegOutValue to the sum of all user peg-out amounts that must be serviced in a peg-out transaction.</p>

<p>We define pegOutValue as usersPegOutValue plus k*(Fi+(U+1)*Fo). We set k=1 (this value is changed if RSKIP241 is activated). U is the number of user peg-outs being processed.</p>

<h3 id="single-pass-scoring-function">Single-Pass Scoring Function</h3>

<p>We define score(u) to be a scoring function of a UTXO u. The algorithm will try to find an UTXO u with the minimum score for a peg-out transaction with a single input u.</p>

<p>The scoring function is:</p>

<p>score(u) = u.amount*10/pegOutValue, which basically chooses the UTXO with lowest amount.</p>

<p>The score is an integer value, and divisions are integer divisions. The function is changed if RSKIP264 is activated.</p>

<h3 id="algorithm">Algorithm</h3>

<p>To select inputs for a peg-out transaction, the Bridge performs at most three steps:</p>

<ol>
  <li><strong>Single-input greedy</strong>: The Bridge will scan all UTXOs and try to find the UTXO with a value higher than the pegOutValue but with the lowest score. If the found UTXO has a score lower than 20, the corresponding UTXO is added as input to the peg-out transaction and the process stops here.</li>
  <li><strong>Lower Amounts, Multi-input expensive</strong>: The Bridge will sort UTXOs by amount, and starting from the UTXO with the lowest amount closest to pegOutValue, it will scan the UTXOs from higher to lower amounts, adding UTXOs to the transaction until the total value added is higher than pegOutValue+Fi*W or the input count reaches Q, where W is the number of inputs added over 1. If the value is covered with Q or less inputs, the process stops here. Q is set to 4 (this value changes if RSKIP270 is activated)</li>
  <li><strong>Higher Amounts, Multi-input expensive</strong>: The Bridge continues using the sorted UTXOs, and going from the highest amount to the lowest amount, it add inputs until the value added is higher than pegOutValue+Fi*W.</li>
</ol>

<h3 id="changes-if-co-activated-with-rskip241">Changes if co-activated with RSKIP241</h3>

<p>We set k=10.</p>

<h3 id="changes-if-co-activated-with-rskip264">Changes if co-activated with RSKIP264</h3>

<p>The scoring function is:</p>

<p>score(u) = (u.amount*10/usersPegOutValue + 3650/daysToTimeLockExpiration(u))/2</p>

<p>daysToTimeLockExpiration(u) is always rounded up, and the minimum value it returns is 1, even if the time-lock is already expired.</p>

<h3 id="changes-if-co-activated-with-rskip270">Changes if co-activated with RSKIP270</h3>

<p>if no input consolidation is required Q is set to 4. If input consolidation is required, then Q is set to 8.</p>

<p>If the peg-out must expand outputs , and before any of the coin selection attempts is made, the Bridge will scan all UTXOs and add the one with the lowest amount to the peg-out transaction. Then the value of the added UTXO will be subtracted from the pegOutValue. If pegOutValue is still positive, the algorithm will proceed finding additional inputs.</p>

<p>If the peg-out must consolidate outputs, then the process will perform the steps in a different order: 2, 1, and 3. Step 2 is performed using Q=8.</p>

<h3 id="changes-if-co-activated-with-rskip272">Changes if co-activated with RSKIP272</h3>

<p>The value usersPegOutValue  is computed after <code class="language-plaintext highlighter-rouge">getFeesForNextPegOutEvent()</code> has been substracted from each amount. All fees collected will be added to the UTXO Maintenance Account.</p>

<p>Fees for the transaction will be paid from the UMA. If the UMA does not have enough funds, then the remaining funds will be paid from the peg balance. If RSKIP272 is not activated, fees will be substracted evenly from every user peg-out output.</p>

<h2 id="rationale">Rationale</h2>

<p>We define a algorithms that implement heuristics that try to:</p>

<ul>
  <li>Keep the number of UTXOs between two bounds.</li>
  <li>Keep a Pareto distribution of amounts over the UTXOs.</li>
  <li>Keep the amount of bitcoins on UTXOs being consumed low, to prevent peg-outs to be blocked waiting for change amounts to return to the peg balance.</li>
  <li>If RSKIP241 is activated, then try to consume extra bitcoins in inputs to be able to bump fees.</li>
  <li>If RSKIP264 is activated, then try to consume inputs that need time-lock refresh.</li>
</ul>

<h3 id="minimization-of-value-in-transit">Minimization of Value in Transit</h3>

<p>Moving additional value apart from the user selected peg-out amounts always carry a certain risk that the change amounts cannot be quickly pegged-in due to the lack of transaction inclusion. This can happen during sudden mempool congestions. 
To reduce this risks, the coin selection algorithm tries to minimize change, yet it behaves mostly greedy. If UTXO amounts are uniformly distributed, it should not consume more than the double of the peg-out amount. 
The proposed coin selection algorithm does not try to find the optimum solution. Finding the best combination of UTXOs is probably as hard as solving the <a href="https://en.wikipedia.org/wiki/Knapsack_problem">Knapsack problem</a>.</p>

<h3 id="simulations">Simulations</h3>

<p><u>The algorithms and thresholds presented here need to be validated by simulations before the RSK community can approve this RSKIP. This section will show the simulation results. This RSKIP will be updated with improved algorithms and thresholds after simulations are completed.</u></p>

<h2 id="backwards-compatibility">Backwards Compatibility</h2>

<p>This change is a hard-fork and therefore all full nodes must be updated. SPV light-clients and Block explorers do not need to be updated.</p>

<h2 id="security-considerations">Security Considerations</h2>

<p>This RSKIP resolves potential DoS attacks on the current coin selection algorithm if the number of UTXOs increases several orders of magnitude.</p>

<h1 id="copyright"><strong>Copyright</strong></h1>

<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>

  </div>

</article>

      </div>
    </main><footer>
    <div class="footer_cont">
        <div class="footer_box">
            <ul class="social-media-list"><li><a href="https://github.com/rsksmart/RSKIPs" target="_blank" rel="noopener"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">Visit on Github</span></a></li></ul>
        </div>
    </div>
</footer><script src="../assets/js/dark_mode.js"></script>
    <script src="../../assets/js/dark_mode.js"></script>
  </body>

</html>
