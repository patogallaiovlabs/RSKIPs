<h1 id="precompiled-contracts-for-bls12-381-curve-operations">Precompiled Contracts for BLS12-381 Curve Operations</h1>

<table>
  <thead>
    <tr>
      <th style="text-align: left">RSKIP</th>
      <th style="text-align: left">188</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left"><strong>Title</strong></td>
      <td style="text-align: left">Precompiled Contracts for BLS12-381 Curve Operations</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Created</strong></td>
      <td style="text-align: left">20-11-2020</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Author</strong></td>
      <td style="text-align: left">FJ</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Purpose</strong></td>
      <td style="text-align: left">Usa</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Layer</strong></td>
      <td style="text-align: left">Core</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Complexity</strong></td>
      <td style="text-align: left">2</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Status</strong></td>
      <td style="text-align: left">Draft</td>
    </tr>
  </tbody>
</table>

<h2 id="abstract">Abstract</h2>

<p>In order to mantain Ethereum compatibility, we introducue a set of precompiled contracts. Enabling efficient operations on BLS12-381 curve, in a necessary set for BLS signature verifications and SNARKs verifications.</p>

<h3 id="proposed-addresses-table">Proposed addresses table</h3>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Precompile</th>
      <th style="text-align: right">Address</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">BLS12_G1ADD</td>
      <td style="text-align: right">0x0a</td>
    </tr>
    <tr>
      <td style="text-align: left">BLS12_G1MUL</td>
      <td style="text-align: right">0x0b</td>
    </tr>
    <tr>
      <td style="text-align: left">BLS12_G1MULTIEXP</td>
      <td style="text-align: right">0x0c</td>
    </tr>
    <tr>
      <td style="text-align: left">BLS12_G2ADD</td>
      <td style="text-align: right">0x0d</td>
    </tr>
    <tr>
      <td style="text-align: left">BLS12_G2MUL</td>
      <td style="text-align: right">0x0e</td>
    </tr>
    <tr>
      <td style="text-align: left">BLS12_G2MULTIEXP</td>
      <td style="text-align: right">0x0f</td>
    </tr>
    <tr>
      <td style="text-align: left">BLS12_PAIRING</td>
      <td style="text-align: right">0x10</td>
    </tr>
    <tr>
      <td style="text-align: left">BLS12_MAP_FP_TO_G1</td>
      <td style="text-align: right">0x11</td>
    </tr>
    <tr>
      <td style="text-align: left">BLS12_MAP_FP2_TO_G2</td>
      <td style="text-align: right">0x12</td>
    </tr>
  </tbody>
</table>

<h2 id="motivation">Motivation</h2>

<p>Motivation of this precompile:</p>
<ul>
  <li>Mantain compatibility between RSK and Ethereum</li>
  <li>Add a cryptographic primitive that allows to get 120+ bits of security for operations over pairing friendly curve compared to the existing BN254 precompile that only provides 80 bits of security.</li>
</ul>

<h2 id="specification">Specification</h2>

<p>If <code class="highlighter-rouge">blockNumber &gt;= N</code> (to be defined) we introduce nine separate precompiles to perform the following operations:</p>

<p><code class="highlighter-rouge">BLS12_G1ADD</code> - to perform point addition on a curve defined over prime field
<code class="highlighter-rouge">BLS12_G1MUL</code> - to perform point multiplication on a curve defined over prime field
<code class="highlighter-rouge">BLS12_G1MULTIEXP</code> - to perform multiexponentiation on a curve defined over prime field
<code class="highlighter-rouge">BLS12_G2ADD</code> - to perform point addition on a curve twist defined over quadratic extension of the base field
<code class="highlighter-rouge">BLS12_G2MUL</code> - to perform point multiplication on a curve twist defined over quadratic extension of the base field
<code class="highlighter-rouge">BLS12_G2MULTIEXP</code> - to perform multiexponentiation on a curve twist defined over quadratic extension of the base field
<code class="highlighter-rouge">BLS12_PAIRING</code> - to perform a pairing operations between a set of pairs of (G1, G2) points
<code class="highlighter-rouge">BLS12_MAP_FP_TO_G1</code> - maps base field element into the G1 point
<code class="highlighter-rouge">BLS12_MAP_FP2_TO_G2</code> - maps extension field element into the G2 point</p>

<p>Mapping functions are implemented according to IEFT specification version <code class="highlighter-rouge">v7</code>(!) using an simplified SWU method. It does NOT perform mapping of the byte string into field element that can be implemented in many different ways and can be efficiently performed in EVM, but only does field arithmetic to map field element into curve point. Such functionality is required for signature schemes.</p>

<p>Multiexponentiation operation is included to efficiently aggregate public keys or individual signer’s signatures during BLS signature verification.</p>

<p>The rest of the specification it’s described at <a href="https://eips.ethereum.org/EIPS/eip-2537">EIP-2537</a></p>

<h2 id="rationale">Rationale</h2>

<p>Motivation section covers a total motivation to have operations over BLS12-381 curve available. We also extend a rationale for move specific fine points.</p>

<p>Multiexponentiation as a separate call</p>

<p>Explicit separate multiexponentiation operation that allows one to save execution time (so gas) by both the algorithm used (namely Peppinger algorithm) and (usually forgotten) by the fact that <code class="highlighter-rouge">CALL</code> operation in Ethereum is expensive (at the time of writing), so one would have to pay non-negigible overhead if e.g. for multiexponentiation of <code class="highlighter-rouge">100</code> points would have to call the multipication precompile <code class="highlighter-rouge">100</code> times and addition for <code class="highlighter-rouge">99</code> times (roughly <code class="highlighter-rouge">138600</code> would be saved).</p>

<h2 id="backwards-compatibility">Backwards Compatibility</h2>

<p>There are no backward compatibility questions.</p>

<h2 id="test-cases">Test Cases</h2>

<p>Due to the large test parameters space we first provide properties that various operations must satisfy. We use additive notation for point operations, capital letters (P, Q) for points, small letters (a, b) for scalars. Generator for G1 is labeled as G, generator for G2 is labeled as H, otherwise we assume random point on a curve in a correct subgroup. 0 means either scalar zero or point of infinity. 1 means either scalar one or multiplicative identity. group_order is a main subgroup order. e(P, Q) means pairing operation where P is in G1, Q is in G2.</p>

<h3 id="requeired-properties-for-basic-ops-addmultiply">Requeired properties for basic ops (add/multiply):</h3>

<ul>
  <li>Commutativity: <code class="highlighter-rouge">P + Q = Q + P</code></li>
  <li>Additive negation: <code class="highlighter-rouge">P + (-P) = 0</code></li>
  <li>Doubling: <code class="highlighter-rouge">P + P = 2*P</code></li>
  <li>Subgroup check: <code class="highlighter-rouge">group_order * P = 0</code></li>
  <li>Trivial multiplication check: <code class="highlighter-rouge">1 * P = P</code></li>
  <li>Multiplication by zero: <code class="highlighter-rouge">0 * P = 0</code></li>
  <li>Multiplication by the unnormalized scalar: <code class="highlighter-rouge">(scalar + group_order) * P = scalar * P</code></li>
</ul>

<h3 id="required-properties-for-pairing-operation">Required properties for pairing operation:</h3>
<ul>
  <li>Degeneracy: <code class="highlighter-rouge">e(P, 0*Q) = e(0*P, Q) = </code>1</li>
  <li>Bilinearity: <code class="highlighter-rouge">e(a*P, b*Q) = e(a*b*P, Q) = e(P, a*b*Q)</code> (internal test, not visible through ABI)</li>
</ul>

<p>Test vector for all operations are expanded in this csv files in repo.</p>

<h2 id="references">References</h2>

<p>[1] <a href="https://eips.ethereum.org/EIPS/eip-2537">EIP-2537</a></p>

<h3 id="copyright">Copyright</h3>

<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
