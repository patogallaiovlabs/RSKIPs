<h1 id="active-federation-creation-block-height-registration">Active Federation creation block height registration</h1>

<table>
  <thead>
    <tr>
      <th style="text-align: left">RSKIP</th>
      <th style="text-align: left">186</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left"><strong>Title</strong></td>
      <td style="text-align: left">Active Federation creation block height registration</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Created</strong></td>
      <td style="text-align: left">19-NOV-20</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Author</strong></td>
      <td style="text-align: left">JD</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Purpose</strong></td>
      <td style="text-align: left">Sec</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Layer</strong></td>
      <td style="text-align: left">Core</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Complexity</strong></td>
      <td style="text-align: left">1</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Status</strong></td>
      <td style="text-align: left">Draft</td>
    </tr>
  </tbody>
</table>

<h2 id="abstract">Abstract</h2>

<p>When the Federation change voting process finishes, the Bridge emmits a <code class="highlighter-rouge">commit_federation</code> event.
This event can be used to provide a blockchain proof of the Federation address when requested. Nowadays doing this would imply navigating the blockchain to determine when it was emmited, or constantly monitoring said events.</p>

<p>This RSKIP proposes adding on-chain information to easily fetch the block where the Federation was changed for the last time. With the block, a system could provide proof that it belongs to the mainchain.</p>

<p>Additionally, once a Federation migration process finishes, the retiring Federation is removed. This RSKIP proposes to keep the last retiring Federation address in storage, to be used in case there are outstanding funds to migrate after the retiring age.</p>

<h2 id="motivation">Motivation</h2>

<p>When a user gets the Federation address they usually interact with a node/service and have to trust this information. This exposes a risk where a man-in-the-middle kind of attack could lead users to send their funds to an invalid address thus losing them.</p>

<h2 id="specification">Specification</h2>

<h3 id="storage-changes">Storage changes</h3>

<p>The Bridge will store three new values:</p>
<ul>
  <li>activeFederationCreationBlockHeight. (long)
    <ul>
      <li>Defaults to the existing Federation activation height</li>
    </ul>
  </li>
  <li>nextFederationCreationBlockHeight. (long)
    <ul>
      <li>Defaults to null.</li>
    </ul>
  </li>
  <li>lastRetiredFederationAddress. (btcAddress)
    <ul>
      <li>Defaults to null.</li>
    </ul>
  </li>
</ul>

<h3 id="commit-federation-process-changes">Commit Federation process changes</h3>

<p>When a new Federation is committed and the <code class="highlighter-rouge">commit_federation</code> event is triggered, the Bridge will store the block height in <code class="highlighter-rouge">nextFederationCreationBlockHeight</code>.</p>

<p>When the Federation is committed, after setting the retiring Federation as the previous one, Bridge will set <code class="highlighter-rouge">lastRetiredFederationAddress</code> using the retiring Federation as its value.</p>

<h3 id="updatecollections-method-changes">updateCollections method changes</h3>

<p>The updateCollections method is responsible for the supporting operations of the Bridge, as such, this method now will have to check if a new Federation became Active.</p>

<p>When a new Federation activates, the Bridge will replace <code class="highlighter-rouge">activeFederationCreationBlockHeight</code> with the value in <code class="highlighter-rouge">nextFederationCreationBlockHeight</code> and clear the value of <code class="highlighter-rouge">nextFederationCreationBlockHeight</code>.</p>

<h3 id="registerbtctransaction-method-changes">registerBtcTransaction method changes</h3>

<p>During the peg-in process, the Bridge evaluates which kind of BTC transaction it is requested to register. To detect if it’s a migration, it checks if the sender is the retiring Federation, and if the recipient is the active Federation. Add to this check that the sender could be the retiring Federation, or the last Retired Federation.</p>

<h3 id="getactivefederationcreationblockheight-method">getActiveFederationCreationBlockHeight method</h3>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>getActiveFederationCreationBlockHeight() returns uint256
</code></pre></div></div>

<p>This method will return the Active Federation block height. To do this, it should:</p>
<ul>
  <li>check if there is a value for <code class="highlighter-rouge">nextFederationCreationBlockHeight</code>.
    <ul>
      <li>If so, it should verify if the current block is higher than or equals to <code class="highlighter-rouge">nextFederationCreationBlockHeight</code> + <code class="highlighter-rouge">federationActivationAge</code> (Mainnet: 18500, Testnet: 60, Regtest: 10).
        <ul>
          <li>If so, it should return <code class="highlighter-rouge">nextFederationCreationBlockHeight</code>.</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>Otherwise, it should return the value stored in <code class="highlighter-rouge">activeFederationCreationBlockHeight</code>.</li>
</ul>

<h2 id="rationale">Rationale</h2>

<h3 id="scope">Scope</h3>

<p>This RSKIP only contemplates the consensus changes, this means that the Bridge will expose a method to get the block, but not a way to generate the merkle proof of said block’s inclusion in the blockchain. Once the consensus changes are in place anyone (e.g. the rskj node) could provide a method to fetch the Federation address with merkleproof.</p>

<h3 id="federation-activation">Federation activation</h3>

<p>When a new Federation is committed, this doesn’t mean the Federation changes immediately, for this to happen a number of blocks has to be mined (18500 in Mainnet), this is the reason why the RSKIP proposes to store two values. It’s important that the block height returned corresponds to the active Federation (return with the Bridge method <code class="highlighter-rouge">getFederationAddress()</code>).</p>

<h3 id="default-federation-activation-block-value">Default Federation activation block value</h3>

<p>There is a risk that in between the node deploy and the consensus activation an unexpected Federation change occurs. If this would happen, the source code could point to an older active Federation creation block.
The only way to solve this would be to ensure that the Federation is not changed once the code is deployed and before the network upgrade is active.</p>

<h3 id="copyright">Copyright</h3>

<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
