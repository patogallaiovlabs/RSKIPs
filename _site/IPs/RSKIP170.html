<h1 id="peg-in-to-any-address">Peg-in to any address</h1>

<table>
  <thead>
    <tr>
      <th style="text-align: left">RSKIP</th>
      <th style="text-align: left">170</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left"><strong>Title</strong></td>
      <td style="text-align: left">Peg-in to any address</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Created</strong></td>
      <td style="text-align: left">01-SEP-20</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Author</strong></td>
      <td style="text-align: left">MI</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Purpose</strong></td>
      <td style="text-align: left">USa</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Layer</strong></td>
      <td style="text-align: left">Core</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Complexity</strong></td>
      <td style="text-align: left">2</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Status</strong></td>
      <td style="text-align: left">Draft</td>
    </tr>
  </tbody>
</table>

<h2 id="abstract">Abstract</h2>

<p>This RSKIP proposes a way for users to transfer BTC to RSK, indicating the RSK address in which they want their RBTCs transferred to and a BTC refund address in case the peg-in can not be completed for some reason.</p>

<h2 id="motivation">Motivation</h2>

<p>Allowing users to peg-in BTC to any address in RSK, EOA or contract.</p>

<h2 id="specification">Specification</h2>

<p>This RSKIP proposes an extension to the current peg-in workflow. By including an output with an OP_RETURN op code and certain payload in the transaction sent to the federation to perform the peg-in, the user can determine the RSK address where the RBTCs will be transferred to and a BTC refund address.</p>

<p>The BTC transaction sent to the federation must contain 
 one output with value 0 and OP_RETURN op code followed by the following data:</p>
<ul>
  <li><code class="highlighter-rouge">52534b54</code> as prefix indicating the output is for RSK. This values stands for <code class="highlighter-rouge">RSKT</code> (for RSK  transfer) in ascii and hex encoded. (4 bytes)</li>
  <li>Protocol version in hexa (1 byte). Currently <strong>01</strong></li>
  <li>A valid RSK address (20 bytes)</li>
  <li>[Optional] A valid BTC refund address in the following format:
    <ul>
      <li>Address type (1 byte)
        <ul>
          <li>01 for P2PKH</li>
          <li>02 for P2SH</li>
        </ul>
      </li>
      <li>Hash needed to build refund address (20 bytes)
        <ul>
          <li>For P2PKH type address: public key hash</li>
          <li>For P2SH type address: script hash</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h3 id="example-output">Example output</h3>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
      "value": 0.00000000,
      "n": 1,
      "scriptPubKey": {
        "asm": "OP_RETURN 52534b5400010e537aad84447a2c2a7590d5f2665ef5cf9b667a014f4c767a2d308eebb3f0f1247f9163c896e0b7d2",
        "hex": "6a2b52534b54010e537aad84447a2c2a7590d5f2665ef5cf9b667a014f4c767a2d308eebb3f0f1247f9163c896e0b7d2",
        "type": "nulldata"
      }
    }
</code></pre></div></div>
<p>Payload included: <code class="highlighter-rouge">52534b54010e537aad84447a2c2a7590d5f2665ef5cf9b667a014f4c767a2d308eebb3f0f1247f9163c896e0b7d2</code></p>

<ul>
  <li>First 4 bytes correspond to the prefix that indicates the output has peg-in instructions for RSK (<code class="highlighter-rouge">RSKT</code> in hexa): <code class="highlighter-rouge">52534b54</code></li>
  <li>Next 1 byte that correspond to the version number in hexa: <code class="highlighter-rouge">01</code></li>
  <li>Next 20 bytes indicate rsk destination address: <code class="highlighter-rouge">0e537aad84447a2c2a7590d5f2665ef5cf9b667a</code></li>
  <li>Next 1 byte indicating btc refund address type, in this case P2PKH: <code class="highlighter-rouge">01</code></li>
  <li>Finally 20 bytes indicating the public key hash that will be used to get the btc refund address: <code class="highlighter-rouge">4f4c767a2d308eebb3f0f1247f9163c896e0b7d2</code></li>
</ul>

<h3 id="new-peg-in-flow">New peg-in flow</h3>

<p>When a BTC transaction is sent to the Bridge, the following steps take place:</p>

<ol>
  <li>Blockchain validations as performed in the existing flow (e.g. amount of confirmations, PMT valid)</li>
  <li>Parse transaction to get RSK destination address and BTC refund address
    <ol>
      <li>If no OP_RETURN data is present, follow the current flow. Get tx sender to use as BTC refund address and derive RSK destination address from BTC public key.</li>
      <li>If OP_RETURN data is present, get RSK destination address from the payload and the BTC refund address if present. In case there is no BTC refund address included in the payload, get the tx sender.</li>
    </ol>
  </li>
</ol>

<h3 id="notes">Notes</h3>
<ul>
  <li>No restriction is added to the maximum length in bytes of the transaction.</li>
  <li>No restriction is added to the total amount of outputs the transaction can have.</li>
  <li>There is no limit to the amount of outputs with OP_RETURN the peg-in transaction can have. But there can be only one with <code class="highlighter-rouge">RSKT</code> prefix indicating peg-in instructions. Transactions with more than one OP_RETURN outputs containing <code class="highlighter-rouge">RSKT</code> prefix will be rejected, following the existing protocol for refunds.</li>
  <li>The output with OP_RETURN containing the peg-in instructions does not have to be in any particular order among the other outputs.</li>
</ul>

<h2 id="rationale">Rationale</h2>

<p><a href="https://github.com/rsksmart/RSKIPs/blob/master/IPs/RSKIP41.md">RSKIP41</a> includes optional fields with the purpose of executing a smart contract in RSK, in case the RSK destination address is a contract instead of an account. In this version of the protocol, the possibility of executing a smart contract from the peg-in transaction is not contemplated.</p>

<p>If the RSK destination address set in the payload is a contract then the locked funds will be transferred to fund this contract. It is <strong>not</strong> required that the contract has a payable fallback function to receive the funds. In case the recipient contract has a payable fallback function with some implementation, the code will not be executed. Only the transfer will be made.</p>

<h2 id="references">References</h2>

<p>[1] https://github.com/rsksmart/RSKIPs/blob/master/IPs/RSKIP41.md</p>

<p>[2] https://bitcoinfoundation.org/files/bitcoin/core-development-update-5/</p>

<h3 id="copyright">Copyright</h3>

<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
