<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>Code Pagination | RSK Improvement Proposals</title>
    <meta
      property="og:title"
      content="Code Pagination | RSK Improvement Proposals"
    />
    <meta name="description" content="RSK Improvement Proposals (RSKIPs) describe standards for the RSK platform, including core protocol specifications, client APIs, and contract standards." />
    <meta property="og:description" content="RSK Improvement Proposals (RSKIPs) describe standards for the RSK platform, including core protocol specifications, client APIs, and contract standards." />
    <meta name="twitter:description" content="RSK Improvement Proposals (RSKIPs) describe standards for the RSK platform, including core protocol specifications, client APIs, and contract standards." />

  <meta name="generator" content="Jekyll" />
  <meta property="og:locale" content="en_US" />
  <link rel="canonical" href="https://ips.rsk.co/IPs/RSKIP30" />
  <meta property="og:url" content="https://ips.rsk.co/IPs/RSKIP30" />
  <meta property="og:site_name" content="RSK Improvement Proposals" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@" />
  <script type="application/ld+json">
    {
      "@type": "WebSite",
      "url": "https://ips.rsk.co",
      "name": "RSK Improvement Proposals",
      "description": "RSK Improvement Proposals (RSKIPs) describe standards for the RSK platform, including core protocol specifications, client APIs, and contract standards.",
      "@context": "https://schema.org"
    }
  </script>
  <link rel="stylesheet" href="/assets/css/style.css" />
      <!-- Google Fonts -->
      <link href="https://fonts.googleapis.com/css?family=Quicksand:400,700,900&display=swap" rel="stylesheet">
      <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,600,700,800&display=swap" rel="stylesheet"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="RSK Improvement Proposals" /><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML" integrity="sha256-nlrDrBTHxJJlDDX22AS33xYI1OJHnGMDhiYMSe2U0e0=" crossorigin="anonymous"></script>
</head>
<body><header class="site-header" role="banner">
  <button id="dark-mode-toggle" class="dark-mode-toggle theme-toggle-button">
    <svg class="icon" style="width:24px;height:24px" viewBox="0 0 24 24">
      <path fill="currentColor" d="M7.5,2C5.71,3.15 4.5,5.18 4.5,7.5C4.5,9.82 5.71,11.85 7.53,13C4.46,13 2,10.54 2,7.5A5.5,5.5 0 0,1 7.5,2M19.07,3.5L20.5,4.93L4.93,20.5L3.5,19.07L19.07,3.5M12.89,5.93L11.41,5L9.97,6L10.39,4.3L9,3.24L10.75,3.12L11.33,1.47L12,3.1L13.73,3.13L12.38,4.26L12.89,5.93M9.59,9.54L8.43,8.81L7.31,9.59L7.65,8.27L6.56,7.44L7.92,7.35L8.37,6.06L8.88,7.33L10.24,7.36L9.19,8.23L9.59,9.54M19,13.5A5.5,5.5 0 0,1 13.5,19C12.28,19 11.15,18.6 10.24,17.93L17.93,10.24C18.6,11.15 19,12.28 19,13.5M14.6,20.08L17.37,18.93L17.13,22.28L14.6,20.08M18.93,17.38L20.08,14.61L22.28,17.15L18.93,17.38M20.08,12.42L18.94,9.64L22.28,9.88L20.08,12.42M9.63,18.93L12.4,20.08L9.87,22.27L9.63,18.93Z" />
    </svg>
  </button>


<div class="wrapper"><a class="site-title" rel="author" href="http://localhost:4000/">RSK Improvement Proposals</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link underline" href="http://localhost:4000/all">All</a><a class="page-link underline" href="http://localhost:4000/scalability">Scalability</a><a class="page-link underline" href="http://localhost:4000/security">Security</a><a class="page-link underline" href="http://localhost:4000/usability">Usability</a><a class="page-link underline" href="http://localhost:4000/fairness">Fairness</a><a class="page-link underline" href="http://localhost:4000/standardtrack">Standard Track</a></div>





      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post">

  <header class="post-header">
    <h1 class="post-title">Code Pagination</h1>
  </header>

  <div class="post-content">
    <h1 id="code-pagination">Code Pagination</h1>

<table>
  <thead>
    <tr>
      <th style="text-align: left">RSKIP</th>
      <th style="text-align: left">30</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left"><strong>Title</strong></td>
      <td style="text-align: left">Code Pagination</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Created</strong></td>
      <td style="text-align: left">01-JAN-2017</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Author</strong></td>
      <td style="text-align: left">SDL</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Purpose</strong></td>
      <td style="text-align: left">Sca</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Layer</strong></td>
      <td style="text-align: left">Core</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Complexity</strong></td>
      <td style="text-align: left">2</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Status</strong></td>
      <td style="text-align: left">Draft</td>
    </tr>
  </tbody>
</table>

<h1 id="abstract"><strong>Abstract</strong></h1>

<p>This RSKIP discusses how to deal with large programs and how calls to such programs should be priced. Currently Ethereum limits a program to 26K bytes to prevent loading an excessive amount of data on a call which has a low cost. However this reduces the capability and simplicity of programming of the platform considerably.</p>

<h1 id="motivation"><strong>Motivation</strong></h1>

<h2 id="size-of-an-rlp-encoded-account">Size of an RLP Encoded Account</h2>

<p>The following fields are encoded in an account (not contract):</p>

<p>nonce = (RLP.encodeBigInteger): avg 4 bytes</p>

<p>balance = (RLP.encodeBigInteger): avg 9 bytes</p>

<p>stateRoot = (RLP.encodeElement): avg 33 bytes</p>

<p>codeHash = (RLP.encodeElement): avg 1 byte</p>

<p>stateFlags = (RLP.encodeInt): avg 1 byte</p>

<p>rlpEncoded = (RLP.encodeList): avg 50 bytes</p>

<p>The node in the trie has the additional overhead of :</p>

<p>Object overhead:  16 bytes?</p>

<p>pointer to partial/total byte[] key of this node: 8 bytes</p>

<p>partial/total byte[] key: 32+16=48 bytes</p>

<p>pointer to right node: 8 bytes</p>

<p>pointer to left node: 8 bytes</p>

<p>Total: 88 bytes.</p>

<p>Total RLP + overhead = ~138 bytes.</p>

<h2 id="discussion">Discussion</h2>

<p>The amount of code that must be loaded when a contract CALL is executed is variable. Ethereum hard-forked to prevent excessive code size to be used as a vector of attack. However, other approaches are possible. It must be noted that loading from SDD/HDD a single byte or a chunk of 36 Kbytes takes the same for a modern OS, since data is stored in blocks. The problem of program size can be solved in several ways:</p>

<ul>
  <li>
    <p>establishing an upper bound (as Ethereum has done)</p>
  </li>
  <li>
    <p>cost of call be in proportion to the size of the code to load</p>
  </li>
  <li>
    <p>paginating program memory.</p>
  </li>
</ul>

<p>The first approach forces the compiler to split a long program into libraries, and use DELEGATECALL as a means to call between them. The problem with this approach is that DELEGATECALL costs 700 gas, while a normal call within the same contract costs 3+8+3+8=22 gas (push retAddress, push callAddress, JUMP, JUMP). This means that the split into libraries must obey a structural rule, such that there are much more inter-library calls than cross-library calls.</p>

<p>The second approach has the drawback that callers need to know the code size and callbacks cannot  be easily programmed.</p>

<p>The third approach seems to be the best.</p>

<h1 id="specification"><strong>Specification</strong></h1>

<p>Code memory is paginated. each page is 8 Kbytes in size. All the static checks are performed when a contract is created, not when a method is called. At the creation time by an external transaction two checks are performed: first the initialization code (containing the payload) and then the payload itself (when it is returned). If the creation is done by the CREATE opcode, then a single check needs to be performed. Since the cost of each code byte is 100 gas (assuming <a href="https://github.com/rsksmart/RSKIPs/blob/master/IPs/RSKIP27.md">RSKIP27</a>), if there is a 4M gas limit, the maximum code size is 40K bytes, or 6 pages. The check consist of:</p>

<ul>
  <li>Making sure that no PUSH opcode overlaps the 8K boundary with its payload. This is because JUMP and JUMPI instructions are not allowed to jump into the payload of PUSH opcodes</li>
</ul>

<p>When the program counter wraps around a page or when a JUMP that points out of a page is executed then the missing page is loaded and a cost of 400 gas units is consumed.. The current RSK platform performs a first pass on code to collect all valid JUMPDEST opcodes that do not lie in PUSH payload, and then only allows those jump destinations. With this change, the table of possible jumpdest will be updated when a new page is loaded by scanning only the loaded page and collecting all JUMPDESTs. This will be possible because PUSH cannot span page boundaries.The page remains in memory until the call ends. A 4M block gas limit allows up to 10K pages to be loaded, totaling 80M bytes of code. The user must however take into account that if the gas limit is reduced, a large contract may be prevented from being called.</p>

<p>The fact that a certain check is performed when code is created (and not when executed) means that contracts that use code as data sets (e.g. a SINE table), may fail to create such data sets. Currently not such failure is possible (only JUMPDEST are tracked). However, this may change in the future, so it’s better to prefix with a PUSH 0x00, JUMP instruction (an infinite loop), so that the remaining parts of the code are inaccessible. Another possibility is to allow “code” to be split into CODE and initialized const DATA sections, as in most executable formats. DATA section can be memory mapped high into the “code” (e.g.  at base offset 0x100000000).</p>

<h1 id="copyright"><strong>Copyright</strong></h1>

<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>

  </div>

</article>

      </div>
    </main><footer>
    <div class="footer_cont">
        <div class="footer_box">
            <ul class="social-media-list"><li><a href="https://github.com/rsksmart/RSKIPs" target="_blank" rel="noopener"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">Visit on Github</span></a></li></ul>
        </div>
    </div>
</footer><script src="../assets/js/dark_mode.js"></script>
    <script src="../../assets/js/dark_mode.js"></script>
  </body>

</html>
