<h1 id="bloom-filter-compression">Bloom filter compression</h1>

<table>
  <thead>
    <tr>
      <th style="text-align: left">RSKIP</th>
      <th style="text-align: left">194</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left"><strong>Title</strong></td>
      <td style="text-align: left">Bloom filter compression</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Created</strong></td>
      <td style="text-align: left">NOV-2020</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Author</strong></td>
      <td style="text-align: left">SDL</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Purpose</strong></td>
      <td style="text-align: left">Sca</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Layer</strong></td>
      <td style="text-align: left">Core</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Complexity</strong></td>
      <td style="text-align: left">1</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Status</strong></td>
      <td style="text-align: left">Draft</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>discussions-to</strong></td>
      <td style="text-align: left">https://research.rsk.dev/t/rskip-194-bloom-filter-compression/73</td>
    </tr>
  </tbody>
</table>

<h1 id="abstract"><strong>Abstract</strong></h1>

<p>In this RSKIP we propose that the bloom filter data is replaced by the hash of the same data when computing the block hash. 
By doing so, systems that verify only cumulative proof of work can download the block headers without the bloom filter data.</p>

<h2 id="motivation">Motivation</h2>

<p>The RSK header has a field called logsBloom that contains 256 bytes that represent a bloom filter updated with the contracts and accounts used in the block. 
This field is seldom used because as more and more transactions are processed in a block, the content becomes more prone to false positives.
There are more efficient techniques to obtain the events generated by a contract, such as using linked-events, proposed the TXINDEX opcode was introduced in RSK, and re-introduced in <a href="https://github.com/rsksmart/RSKIPs/blob/master/IPs/RSKIP192.md">RSKIP192</a>.</p>

<p>The size of the bloom filter is problematic in two contexts:</p>

<ol>
  <li>Light clients must download the data of the bloom filter even if they do not require it.</li>
  <li>The PowHSM must receive and skip all information regarding the bloom filter for every header processed, which includes blocks in the main chain and block headers of referenced uncles.</li>
</ol>

<p>This RSKP solves both problems. PowHSMs can receive a compressed encoding of the block header. Light clients can avoid downloading the bloom filter (using a new network command) or download it and later discarding it.</p>

<p>Another motivation for this RSKIP is that the RSK block lacks a simple versioning system. Every new change requires using the number of fields to detect which type of block it is.
As the number of modifications to the block header performed in hard forks increases, the changes can be mixed in different ways to create a high and unnecessary number of different types of blocks.
This increases the complexity of validation code and makes unit testing really hard to cover all cases.</p>

<p>This RSKIP adds to the block header a <code class="highlighter-rouge">blockVersion</code> field that allows clients to take decisions based on the blockVersion instead of trying to infer it.
To detect this new field, the size of the bloom filter field is used, but hopefully after this change no other attributes of the fields will be used to detect the block version.</p>

<h2 id="specification">Specification</h2>

<p>The RSK block header is a list of the following elements:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>parentHash, unclesHash, coinbase,stateRoot, txTrieRoot, receiptTrieRoot, logsBloom, difficulty, number, gasLimit, gasUsed, timestamp, extraData, paidFees, minimumGasPrice, uncleCount, ummRoot [, mergeMiningFields ] 
</code></pre></div></div>

<p>The <em>mergeMiningFields</em> are the following:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bitcoinMergedMiningHeader,
bitcoinMergedMiningMerkleProof,
bitcoinMergedMiningCoinbaseTransaction
</code></pre></div></div>

<p>All blocks prior the hard-fork block number are considered version 0.
Afterward, new blocks must be version 1.
For block headers version 1, there are two separate serialization methods, one for the transfer of the block header information and the other for the computation of the block hash.
When serializing the block header version 1 to obtain the block hash, the field logsBloom is replaced by an RLP list of:</p>

<ul>
  <li>The blockVersion field (integer) (1 byte)</li>
  <li>The Keccak hash of the bloom filter data (32 bytes).</li>
</ul>

<p>When serializing the block header for transmission or storage, the logsBloom field is:</p>
<ul>
  <li>The blockVersion field (integer) (1 byte)</li>
  <li>The bloom filter data (256 bytes).</li>
</ul>

<p>Consensus must validate that the blockVersion is exactly 1 for blocks after the hard fork, until this number is incremented by another consensus change.</p>

<h2 id="rationale">Rationale</h2>

<p>Generally the blockVersion is stored as the first field of an object.
While this is entirely possible for RSK block headers, PowHSMs cannot understand any other block header format. However, PowHSM can verify without problem a block header with shorter data stored in the logsBloom field.
To avoid forcing a costly firmware upgrade for all PowHSMs, the blockVersion is stored in the logsBloom filter, which is unchecked by the hardware.</p>

<p>While computing the hash without the full bloom filter data may incentivize nodes to remove this data permanently, the overhead of the bloom filter data is very low for blocks with many transactions. Therefore this incentive is weak.</p>

<p>An improved version of this RSKIP would also hash the fields coinbase, stateRoot, txTrieRoot, receiptTrieRoot, gasLimit, gasUsed, extraData, paidFees, minimumGasPrice, uncleCount and ummRoot into the same inner hash, saving another 145 bytes. This change converts the RSK header into a mini-header, resembling the old <a href="https://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.1046.128&amp;rep=rep1&amp;type=pdf">mini-blockchain</a> proposal (updated <a href="http://cryptochainuni.com/wp-content/uploads/The-Mini-Blockchain-Scheme.pdf">here</a>). However this change requires the upgrade of the PowHSM firmware, and therefore it should be considered if there is a PowHSM firmware upgrade agreed by the community. This technique can be later combined by <a href="https://arxiv.org/pdf/2004.06911.pdf">coinprune</a>-like method to reduce the blockchain size even more.</p>

<h2 id="backwards-compatibility">Backwards Compatibility</h2>

<p>This change is a hard-fork and therefore all full nodes must be updated.</p>

<p>Block explorers do not need to be updated, as the RPC interface will return the serialization block header that corresponds with the expanded version of the block header.</p>

<p>SPV light-clients wonâ€™t be able to take advantage of all the benefits of this change until they can request from peers the compressed format of block headers.
PowHSM do not need to be upgraded to support this change.</p>

<h2 id="test-cases">Test Cases</h2>

<p>TBD</p>

<h2 id="implementation">Implementation</h2>

<p>TBD</p>

<h2 id="security-considerations">Security Considerations</h2>

<p>No new security issue was identified related to this RSKIP.</p>

<h1 id="copyright"><strong>Copyright</strong></h1>

<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.,</p>

