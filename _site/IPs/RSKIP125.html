<h1 id="create2">Create2</h1>

<table>
  <thead>
    <tr>
      <th style="text-align: left">RSKIP</th>
      <th style="text-align: left">125</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left"><strong>Title</strong></td>
      <td style="text-align: left">Create2</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Created</strong></td>
      <td style="text-align: left">29-APR-19</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Author</strong></td>
      <td style="text-align: left">SMS</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Purpose</strong></td>
      <td style="text-align: left">Sca, Usa</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Layer</strong></td>
      <td style="text-align: left">Core</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Complexity</strong></td>
      <td style="text-align: left">1</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Status</strong></td>
      <td style="text-align: left">Adopted</td>
    </tr>
  </tbody>
</table>

<h2 id="abstract">Abstract</h2>

<p>The purpose of this IP is to implement the CREATE2 opcode, as added to the Ethereum VM in the <a href="http://eips.ethereum.org/EIPS/eip-1014">EIP 1014</a></p>

<h2 id="motivation">Motivation</h2>

<p>Enables the creation of contracts with deterministic and repeatable addresses. This functionality is required for state channels interacting with a contract that only needs to be created on arbitration (also called counterfactual channels).</p>

<h2 id="specification">Specification</h2>

<p>Adds a new opcode at 0xf5, which takes 4 stack arguments: endowment, memory_start, memory_length, salt. Behaves identically to CREATE, except using <code class="highlighter-rouge">keccak256( 0xff ++ address ++ salt ++ keccak256(init_code))[12:]</code> instead of the usual sender-and-nonce-hash as the address where the contract is initialized at.</p>

<p>The <code class="highlighter-rouge">CREATE2</code> has the same <code class="highlighter-rouge">gas</code> schema as <code class="highlighter-rouge">CREATE</code>, but also an extra <code class="highlighter-rouge">hashcost</code> of <code class="highlighter-rouge">GSHA3WORD * ceil(len(init_code) / 32)</code>, to account for the hashing that must be performed. The <code class="highlighter-rouge">hashcost</code> is deducted at the same time as memory-expansion gas and <code class="highlighter-rouge">CreateGas</code> is deducted: <em>before</em> evaluation of the resulting address and the execution of <code class="highlighter-rouge">init_code</code>.</p>

<ul>
  <li><code class="highlighter-rouge">0xff</code> is a single byte,</li>
  <li><code class="highlighter-rouge">address</code> is always <code class="highlighter-rouge">20</code> bytes,</li>
  <li><code class="highlighter-rouge">salt</code> is always <code class="highlighter-rouge">32</code> bytes (a stack item).</li>
</ul>

<p>The preimage for the final hashing round is thus always exactly <code class="highlighter-rouge">85</code> bytes long.</p>

<h2 id="rationale">Rationale</h2>

<h4 id="address-formula">Address formula</h4>

<ul>
  <li>Ensures that addresses created with this scheme cannot collide with addresses created using the traditional <code class="highlighter-rouge">keccak256(rlp([sender, nonce]))</code> formula, as <code class="highlighter-rouge">0xff</code> can only be a starting byte for RLP for data many petabytes long.</li>
  <li>Ensures that the hash preimage has a fixed size,</li>
</ul>

<h4 id="gas-cost">Gas cost</h4>

<p>Since address calculation depends on hashing the <code class="highlighter-rouge">init_code</code>, it would leave clients open to DoS attacks if executions could repeatedly cause hashing of large pieces of <code class="highlighter-rouge">init_code</code>, since expansion of memory is paid for only once. This EIP uses the same cost-per-word as the <code class="highlighter-rouge">SHA3</code> opcode.</p>

<h3 id="the-create-behavior-change">The <code class="highlighter-rouge">CREATE</code> behavior change</h3>

<p>The original <a href="http://eips.ethereum.org/EIPS/eip-1014">EIP</a> specified what to do in cases of a hash collision of the new address. Basically, in order to prevent this problem, each new contract created by these opcodes would start with its nonce in one, instead of zero. In addition, when there is a collision there is a check done if the existing contract has either non empty code, or non zero nonce, if one of this checks is true then the contract creation fails as if the init_code program would fail.</p>

<p>This RSKIP introduces a new behavior for the <code class="highlighter-rouge">CREATE</code> opcode, because every contract created will start with nonce 1, and fail in the rare case that a contract with the same address was previously created. The behavior is exactly the same than in the Ethereum VM, thus improving compatibility.</p>

<h3 id="examples">Examples</h3>

<p>Example 0</p>
<ul>
  <li>address <code class="highlighter-rouge">0x0000000000000000000000000000000000000000</code></li>
  <li>salt <code class="highlighter-rouge">0x0000000000000000000000000000000000000000000000000000000000000000</code></li>
  <li>init_code <code class="highlighter-rouge">0x00</code></li>
  <li>gas (assuming no mem expansion): <code class="highlighter-rouge">32006</code></li>
  <li>result: <code class="highlighter-rouge">0x4D1A2e2bB4F88F0250f26Ffff098B0b30B26BF38</code></li>
</ul>

<p>Example 1</p>
<ul>
  <li>address <code class="highlighter-rouge">0xdeadbeef00000000000000000000000000000000</code></li>
  <li>salt <code class="highlighter-rouge">0x0000000000000000000000000000000000000000000000000000000000000000</code></li>
  <li>init_code <code class="highlighter-rouge">0x00</code></li>
  <li>gas (assuming no mem expansion): <code class="highlighter-rouge">32006</code></li>
  <li>result: <code class="highlighter-rouge">0xB928f69Bb1D91Cd65274e3c79d8986362984fDA3</code></li>
</ul>

<p>Example 2</p>
<ul>
  <li>address <code class="highlighter-rouge">0xdeadbeef00000000000000000000000000000000</code></li>
  <li>salt <code class="highlighter-rouge">0x000000000000000000000000feed000000000000000000000000000000000000</code></li>
  <li>init_code <code class="highlighter-rouge">0x00</code></li>
  <li>gas (assuming no mem expansion): <code class="highlighter-rouge">32006</code></li>
  <li>result: <code class="highlighter-rouge">0xD04116cDd17beBE565EB2422F2497E06cC1C9833</code></li>
</ul>

<p>Example 3</p>
<ul>
  <li>address <code class="highlighter-rouge">0x0000000000000000000000000000000000000000</code></li>
  <li>salt <code class="highlighter-rouge">0x0000000000000000000000000000000000000000000000000000000000000000</code></li>
  <li>init_code <code class="highlighter-rouge">0xdeadbeef</code></li>
  <li>gas (assuming no mem expansion): <code class="highlighter-rouge">32006</code></li>
  <li>result: <code class="highlighter-rouge">0x70f2b2914A2a4b783FaEFb75f459A580616Fcb5e</code></li>
</ul>

<p>Example 4</p>
<ul>
  <li>address <code class="highlighter-rouge">0x00000000000000000000000000000000deadbeef</code></li>
  <li>salt <code class="highlighter-rouge">0x00000000000000000000000000000000000000000000000000000000cafebabe</code></li>
  <li>init_code <code class="highlighter-rouge">0xdeadbeef</code></li>
  <li>gas (assuming no mem expansion): <code class="highlighter-rouge">32006</code></li>
  <li>result: <code class="highlighter-rouge">0x60f3f640a8508fC6a86d45DF051962668E1e8AC7</code></li>
</ul>

<p>Example 5</p>
<ul>
  <li>address <code class="highlighter-rouge">0x00000000000000000000000000000000deadbeef</code></li>
  <li>salt <code class="highlighter-rouge">0x00000000000000000000000000000000000000000000000000000000cafebabe</code></li>
  <li>init_code <code class="highlighter-rouge">0xdeadbeefdeadbeefdeadbeefdeadbeefdeadbeefdeadbeefdeadbeefdeadbeefdeadbeefdeadbeefdeadbeef</code></li>
  <li>gas (assuming no mem expansion): <code class="highlighter-rouge">32012</code></li>
  <li>result: <code class="highlighter-rouge">0x1d8bfDC5D46DC4f61D6b6115972536eBE6A8854C</code></li>
</ul>

<p>Example 6</p>
<ul>
  <li>address <code class="highlighter-rouge">0x0000000000000000000000000000000000000000</code></li>
  <li>salt <code class="highlighter-rouge">0x0000000000000000000000000000000000000000000000000000000000000000</code></li>
  <li>init_code <code class="highlighter-rouge">0x</code></li>
  <li>gas (assuming no mem expansion): <code class="highlighter-rouge">32000</code></li>
  <li>result: <code class="highlighter-rouge">0xE33C0C7F7df4809055C3ebA6c09CFe4BaF1BD9e0</code></li>
</ul>

<h3 id="copyright">Copyright</h3>

<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
