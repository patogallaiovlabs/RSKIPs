<h1 id="clean-evm-internal-buffer-in-call-like-opcodes">Clean EVM Internal Buffer in Call-like Opcodes</h1>

<table>
  <thead>
    <tr>
      <th style="text-align: left">RSKIP</th>
      <th style="text-align: left">171</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left"><strong>Title</strong></td>
      <td style="text-align: left">Clean EVM Internal Buffer in Call-like Opcodes</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Created</strong></td>
      <td style="text-align: left">02-09-2020</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Author</strong></td>
      <td style="text-align: left">FJ</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Purpose</strong></td>
      <td style="text-align: left">Usa</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Layer</strong></td>
      <td style="text-align: left">Core</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Complexity</strong></td>
      <td style="text-align: left">1</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Status</strong></td>
      <td style="text-align: left">Accepted</td>
    </tr>
  </tbody>
</table>

<h2 id="abstract">Abstract</h2>

<p>The purpose of this RSKIP is to make RSK fully compatible with <a href="https://github.com/ethereum/EIPs/blob/master/EIPS/eip-211.md">EIP-211</a>. <code class="highlighter-rouge">RETURNDATACOPY</code> and <code class="highlighter-rouge">RETURNDATASIZE</code> opcodes have already been implemented in previous RSKIPs, but still, there were some corner cases related to call-like opcodes that weren’t implemented in previous network upgrades.</p>

<p>Now with this RSKIP we have a mechanism to allow returning arbitrary-length data inside the EVM (<a href="https://github.com/ethereum/EIPs/blob/master/EIPS/eip-211.md">EIP-211</a>).</p>

<h2 id="motivation">Motivation</h2>

<p>Described at <a href="https://github.com/ethereum/EIPs/blob/master/EIPS/eip-211.md">EIP-211</a>.</p>

<h2 id="specification">Specification</h2>

<p>This RSKIP will be enabled only if <code class="highlighter-rouge">block.number &gt;= IRIS_HARD_FORK</code>.</p>

<p>Any opcode that creates a new call frame will be mentioned as call-like opcode</p>

<p>Considered call-like opcodes:</p>
<ul>
  <li><code class="highlighter-rouge">OP_CALL</code></li>
  <li><code class="highlighter-rouge">OP_CALLCODE</code></li>
  <li><code class="highlighter-rouge">OP_DELEGATECALL</code></li>
  <li><code class="highlighter-rouge">OP_STATICCALL</code></li>
  <li>Further call-like opcodes may be added in future RSKIPs</li>
</ul>

<p>Since most of the parts of mentioned EIP have already been implemented, this proposal only points to implement this described behaviour:</p>

<blockquote>
  <p>If the call-like opcode is executed but does not really instantiate a call frame (for example due to insufficient funds for a value transfer or if the called contract does not exist), the return data buffer is empty.</p>
</blockquote>

<h2 id="reproducing-misbehaviour">Reproducing misbehaviour</h2>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    // Considering this contract invocation call at 0x471fd3ad3e9eeadeec4608b92d16ce6b500704cc
    PUSH1 0x10
    PUSH1 0x05
    ADD
    PUSH1 0x40
    MSTORE
    PUSH1 0x20
    PUSH1 0x40
    RETURN

    // And this EVM execution
    PUSH1 0x20                                          // return size is 32 bytes
    PUSH1 0x40                                          // on free memory pointer
    PUSH1 0x00                                          // no argument
    PUSH1 0x00                                          // no argument size
    PUSH20 0x471fd3ad3e9eeadeec4608b92d16ce6b500704cc   // suppose a valid contract
    PUSH4 0x005B8D80                                    // with some gas
    STATICCALL                                          // call it (call-like opcode)! internal buffer should be 0x15
    PUSH1 0x20                                          // now do the same...
    PUSH1 0x40                                          // on free memory pointer
    PUSH1 0x00                                          // no argument
    PUSH1 0x00                                          // no argument size
    PUSH1 0x00                                          // but call a non-existent contract (this won't produce a new call frame)
    PUSH4 0x005B8D80                                    // with some gas
    STATICCALL                                          // call it (call-like opcode)!
</code></pre></div></div>

<p>Internal buffer should be 0x00 when RSKIP171 is enabled. If RSKIP171 is disabled and you execute any call-like opcode, the internal state buffer will remain the same, even if that execution didn’t produce any new call frame.</p>

<h2 id="backwards-compatibility">Backwards Compatibility</h2>

<p>Apart from the described behaviour for call-like opcodes, this proposal stays fully backwards compatible.</p>

<h2 id="references">References</h2>

<p>[1] EIP-211 https://github.com/ethereum/EIPs/blob/master/EIPS/eip-211.md</p>

<h3 id="copyright">Copyright</h3>

<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
