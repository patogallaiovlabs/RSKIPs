<h1 id="new-method-getbtctransactionconfirmations-for-bridge-contract">New method GetBtcTransactionConfirmations for Bridge contract</h1>

<table>
  <thead>
    <tr>
      <th style="text-align: left">RSKIP</th>
      <th style="text-align: left">122</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left"><strong>Title</strong></td>
      <td style="text-align: left">New method GetBtcTransactionConfirmations for Bridge contract</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Created</strong></td>
      <td style="text-align: left">03-May-19</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Author</strong></td>
      <td style="text-align: left">AM</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Purpose</strong></td>
      <td style="text-align: left">Usa</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Layer</strong></td>
      <td style="text-align: left">Core</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Complexity</strong></td>
      <td style="text-align: left">2</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Status</strong></td>
      <td style="text-align: left">Draft</td>
    </tr>
  </tbody>
</table>

<h2 id="abstract">Abstract</h2>

<p>A new method for the Bridge contract is introduced. This method provides a service to verify whether a given transaction belongs to a given block within the Bridge contract’s view of the Bitcoin blockchain.</p>

<h2 id="motivation">Motivation</h2>

<p>With the arising need of BTOs (Bitcoin Token Offerings) on top of the RSK network, the ability for RSK smart contracts to test whether a certain Bitcoin transaction has been mined (and how many blocks ago) becomes mandatory. Note that the possibility of ad-hoc implementations doesn’t exist, since to this day there is no method (or group of methods) that enable a smart contract to inspect the Bridge contract’s Bitcoin block headers. When designing the implementation, the decision favored a simple unique method tailored at both verifying the inclusion of a given transaction in a given block (via an SPV proof) as well as the inclusion of the latter in the Bridge’s Bitcoin blockchain, thus proving or disproving the mined status of any given Bitcoin transaction. As a corollary, the method also informs the number of confirmations for the block, enhancing the calling contract’s decision making ability with  a more fine-grained control.</p>

<h2 id="specification">Specification</h2>

<p>A new method for the Bridge precompiled contract (accessible at the <code class="highlighter-rouge">0x0000000000000000000000000000000001000006</code> address) is available. Its signature is as follows:</p>

<ul>
  <li><code class="highlighter-rouge">getBtcTransactionConfirmations(bytes32, bytes32, uint256, bytes32[]) returns (int256)</code></li>
</ul>

<h3 id="parameters">Parameters</h3>

<p>The <code class="highlighter-rouge">getBtcTransactionConfirmations</code> method takes four parameters. In order, these are:</p>

<ol>
  <li>The Bitcoin transaction hash (<code class="highlighter-rouge">bytes32</code>): this is the hash of the transaction that is to be checked for inclusion in the Bitcoin blockchain.</li>
  <li>The Bitcoin block hash (<code class="highlighter-rouge">bytes32</code>): this is the hash of the block that is to be checked for both including the given transaction and inclusion in the Bitcoin blockchain (thus then proving the transaction’s own inclusion in the blockchain).</li>
  <li>The merkle branch path (<code class="highlighter-rouge">uint256</code>): this is the “path” portion of the merkle branch (see the corresponding section for details).</li>
  <li>The merkle branch hashes (<code class="highlighter-rouge">bytes32[]</code>): this is the “hashes” portion of the merkle branch (see the corresponding section for details).</li>
</ol>

<h3 id="return-values">Return values</h3>

<p>The <code class="highlighter-rouge">getBtcTransactionConfirmations</code> returns a single integer (<code class="highlighter-rouge">int256</code>) as a result of its execution. This can either represent <em>success</em> (i.e., the transaction indeed is included in the Bitcoin blockchain) or <em>failure</em> (i.e., the transaction inclusion in the blockchain couldn’t be proved). In the case of <em>success</em>, the return value will be greater than zero, and it will indicate how many confirmations the given block - and transaction - have in the Bridge contract’s Bitcoin blockchain (note that this could differ from other existing - non-blockchain-based, external - Bitcoin nodes, given that update intervals for the Bridge blockchain can be slower). In the case of <em>failure</em>, the return value will be a negative number, and it will show what went wrong. Possible values are:</p>

<ul>
  <li><code class="highlighter-rouge">-1</code>: The block hash given doesn’t exist in the blockchain. This could well be due to the aforementioned delay.</li>
  <li><code class="highlighter-rouge">-2</code>: The block hash corresponds to a block that is not the Bitcoin best chain.</li>
  <li><code class="highlighter-rouge">-4</code>: The block hash given corresponds to a block that is too old to be processed (i.e., its depth with respect to the head of the chain is greater than <code class="highlighter-rouge">4320</code>).</li>
  <li><code class="highlighter-rouge">-5</code>: The given merkle branch fails to prove the inclusion of the given transaction in the given block.</li>
  <li><code class="highlighter-rouge">-3</code>: An inconsistency ocurred that prevented the block from being found. This would occur due to an internal, unexpected problem.</li>
</ul>

<h3 id="merkle-branch">Merkle branch</h3>

<p>A merkle branch is a data structure that serves the purpose of proving the inclusion of a single given transaction in a given block. This data structure takes advantage of the block header merkle root and its underlying merkle tree. In fact, a merkle branch is exactly what its name suggests: a list of intermediate hashes from the leaf (corresponding to the desired transaction) to the merkle root, plus information on the “shape” of the branch itself. This information is precisely what the third and four parameters of the <code class="highlighter-rouge">getBtcTransactionConfirmations</code> method represent. The algorithm to build a merkle branch from a merkle tree is depicted next:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1. Let tx be the hash of the transaction one wishes to prove inclusion on, and mt the corresponding block's merkle tree.
2. Let height(mt) be the height of a given merkle tree.
3. Let mt[i] be the ith level of the tree, with 0 being the leaf level and height(mt) being the root level (this last of size 1, such that mt[height(mt)][0] is the merkle root).
4. Let then mt[i][j] be the jth node of the ith level of the tree.

5. Let txi be the index such that mt[0][txi] equals tx.
6. Let mbhashes be an empty array; lix = txi; mbpath = 0.
7. With level from 0 to height(mt)-1 do:  
7a.    if lix is even:  
7a1.       mbpath = mbpath + (1 &lt;&lt; (height(mt)-level-1))
7a2.       append mt[level][lix+1] to mbhashes (use mt[level][lix] if lix+1 is out of range)  
7b.    else:  
7b1.       append mt[level][lix-1] to mbhashes
7c.    lix = floor(lix/2)

8. Return (mbhashes, mbpath).
</code></pre></div></div>

<h2 id="references">References</h2>

<p>[1] Simplified Payment Verification https://bitcoin.org/en/operating-modes-guide#simplified-payment-verification-spv</p>

<p>[2] Merkle trees https://en.bitcoin.it/wiki/Protocol_documentation#Merkle_Trees</p>

<p>[3] Bitcoin blockchain guide https://bitcoin.org/en/blockchain-guide#introduction</p>

<h3 id="copyright">Copyright</h3>

<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
