<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>Bridge UTXO Management Account | RSK Improvement Proposals</title>
    <meta
      property="og:title"
      content="Bridge UTXO Management Account | RSK Improvement Proposals"
    />
    <meta name="description" content="RSK Improvement Proposals (RSKIPs) describe standards for the RSK platform, including core protocol specifications, client APIs, and contract standards." />
    <meta property="og:description" content="RSK Improvement Proposals (RSKIPs) describe standards for the RSK platform, including core protocol specifications, client APIs, and contract standards." />
    <meta name="twitter:description" content="RSK Improvement Proposals (RSKIPs) describe standards for the RSK platform, including core protocol specifications, client APIs, and contract standards." />

  <meta name="generator" content="Jekyll" />
  <meta property="og:locale" content="en_US" />
  <link rel="canonical" href="https://ips.rsk.co/IPs/RSKIP272" />
  <meta property="og:url" content="https://ips.rsk.co/IPs/RSKIP272" />
  <meta property="og:site_name" content="RSK Improvement Proposals" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@" />
  <script type="application/ld+json">
    {
      "@type": "WebSite",
      "url": "https://ips.rsk.co",
      "name": "RSK Improvement Proposals",
      "description": "RSK Improvement Proposals (RSKIPs) describe standards for the RSK platform, including core protocol specifications, client APIs, and contract standards.",
      "@context": "https://schema.org"
    }
  </script>
  <link rel="stylesheet" href="/assets/css/style.css" />
      <!-- Google Fonts -->
      <link href="https://fonts.googleapis.com/css?family=Quicksand:400,700,900&display=swap" rel="stylesheet">
      <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,600,700,800&display=swap" rel="stylesheet"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="RSK Improvement Proposals" /><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML" integrity="sha256-nlrDrBTHxJJlDDX22AS33xYI1OJHnGMDhiYMSe2U0e0=" crossorigin="anonymous"></script>
</head>
<body><header class="site-header" role="banner">
  <button id="dark-mode-toggle" class="dark-mode-toggle theme-toggle-button">
    <svg class="icon" style="width:24px;height:24px" viewBox="0 0 24 24">
      <path fill="currentColor" d="M7.5,2C5.71,3.15 4.5,5.18 4.5,7.5C4.5,9.82 5.71,11.85 7.53,13C4.46,13 2,10.54 2,7.5A5.5,5.5 0 0,1 7.5,2M19.07,3.5L20.5,4.93L4.93,20.5L3.5,19.07L19.07,3.5M12.89,5.93L11.41,5L9.97,6L10.39,4.3L9,3.24L10.75,3.12L11.33,1.47L12,3.1L13.73,3.13L12.38,4.26L12.89,5.93M9.59,9.54L8.43,8.81L7.31,9.59L7.65,8.27L6.56,7.44L7.92,7.35L8.37,6.06L8.88,7.33L10.24,7.36L9.19,8.23L9.59,9.54M19,13.5A5.5,5.5 0 0,1 13.5,19C12.28,19 11.15,18.6 10.24,17.93L17.93,10.24C18.6,11.15 19,12.28 19,13.5M14.6,20.08L17.37,18.93L17.13,22.28L14.6,20.08M18.93,17.38L20.08,14.61L22.28,17.15L18.93,17.38M20.08,12.42L18.94,9.64L22.28,9.88L20.08,12.42M9.63,18.93L12.4,20.08L9.87,22.27L9.63,18.93Z" />
    </svg>
  </button>


<div class="wrapper"><a class="site-title" rel="author" href="http://localhost:4000/">RSK Improvement Proposals</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link underline" href="http://localhost:4000/all">All</a><a class="page-link underline" href="http://localhost:4000/scalability">Scalability</a><a class="page-link underline" href="http://localhost:4000/security">Security</a><a class="page-link underline" href="http://localhost:4000/usability">Usability</a><a class="page-link underline" href="http://localhost:4000/fairness">Fairness</a><a class="page-link underline" href="http://localhost:4000/standardtrack">Standard Track</a></div>





      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post">

  <header class="post-header">
    <h1 class="post-title">Bridge UTXO Management Account</h1>
  </header>

  <div class="post-content">
    <h1 id="bridge-utxo-management-account">Bridge UTXO Management Account</h1>

<table>
  <thead>
    <tr>
      <th style="text-align: left">RSKIP</th>
      <th style="text-align: left">272</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left"><strong>Title</strong></td>
      <td style="text-align: left">Bridge UTXO Management Account</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Created</strong></td>
      <td style="text-align: left">AUG-2021</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Author</strong></td>
      <td style="text-align: left">SDL</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Purpose</strong></td>
      <td style="text-align: left">Sec, Usa</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Layer</strong></td>
      <td style="text-align: left">Core</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Complexity</strong></td>
      <td style="text-align: left">2</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Status</strong></td>
      <td style="text-align: left">Draft</td>
    </tr>
  </tbody>
</table>

<h1 id="abstract"><strong>Abstract</strong></h1>

<p>One of the problems of the RSK bridge is that peg-out fees are unknown to the user until the peg-out is executed, and the fees are decremented from the peg-out amount. The user has no control of the final amount to be received. This RSKIP proposes a new algorithm for the Bridge to pay for all peg-outs, and charge the users a predictable dynamically-adjusted fee. The results is a much better user experience.</p>

<h2 id="motivation">Motivation</h2>

<p>The current RSK bridge can suffer from a number of problems described in <a href="https://github.com/rsksmart/RSKIPs/blob/master/IPs/RSKIP265.md">RSKIP265</a>. In this RSKIP weâ€™re mostly concerned with the variable peg-out costs. The proposed solution is to provide to the user a method to query the fees to be paid, and charge that amount to the user. This is done by maintaining a separate Bridge balance used for peg-out fee payments. In the future this balance can be used for other UTXO management activities, such as refresh of UTXO time-locks.</p>

<h2 id="specification">Specification</h2>

<p>The Bridge contract will try to maintain a <strong>UTXO Management Account (UMA)</strong> with a balance high enough to pay for peg-outs, UTXO consolidations (if <a href="https://github.com/rsksmart/RSKIPs/blob/master/IPs/RSKIP271.md">RSKIP171</a> is activated), time-lock refresh (if <a href="https://github.com/rsksmart/RSKIPs/blob/master/IPs/RSKIP264.md">RSKIP264</a> is activated) and other maintenance operations without the need to charge peg-in or peg-out users.</p>

<p>The bridge computes two values: Fi and Fo. Fi represents the cost in fees of consuming a single Powpeg input, and Fo is the cost of one P2SH output.</p>

<p>We define a threshold T(n) as the fee cost of a transactions consuming n Powpeg Bitcoin inputs. We compute T(n) as (n*Fi+2*Fo).
If the UMA balance is lower than T(C), then peg-outs users will be charged 10% more, and the Bridge will move the collected extra fee to the UMA account. If the balance is higher than T(B), then the peg-outs will be charged 10% less. The values C and B are defined in the following way:</p>

<p>If peg-out batching is activated (<a href="https://github.com/rsksmart/RSKIPs/blob/master/IPs/RSKIP271.md">RSKIP271</a>) then the constants selected are B=60 and C=30.</p>

<p>If peg-out batching is not activated, then B=600 and C=300.</p>

<p>If <a href="https://github.com/rsksmart/RSKIPs/blob/master/IPs/RSKIP270.md">RSKIP270</a> is activated, then B and C must match those defined in RSKIP270.</p>

<p>The UMA account amount will be stored in the bridge contract, and a new method <code class="language-plaintext highlighter-rouge">getUMABalance()</code> will be enabled to query its current balance. If <a href="https://github.com/rsksmart/RSKIPs/blob/master/IPs/RSKIP265.md">RSKIP265</a> is activated together with this RSKIP, this account will also be used to pay for UTXO refresh required to avoid the emergency time-lock from expiring.</p>

<h3 id="peg-out-fees">Peg-out Fees</h3>

<p>The peg-out fees are fixed to let user known in advance how much they may need to pay for each peg out. A new bridge method <code class="language-plaintext highlighter-rouge">getFeesForNextPegOutEvent()</code> is added for this purpose.</p>

<p>This method returns (adjustFactor*avgFee), where, avgFee is the average fee paid by each transaction in the the past 24 peg-out events, except for the last event which is excluded. To compute avgFee, when an peg-out event ends, the Bridge records the average fee per transaction that would have been required not to modify the UMA balance. The value for avgFee is updated each time a peg-out event ends.</p>

<p>At the RSKIP activation block, avgFee is set to (Fi*1.5+2*+Fo). The value of avgFee is updated once the first 24 peg-out events after activation have been executed.</p>

<p>When the peg-out events is triggered, all users waiting to peg-out are immediately charged <code class="language-plaintext highlighter-rouge">getFeesForNextPegOutEvent()</code>.</p>

<p>The value adjustFactor is 0.9 if the UMA balance is higher than T(B), 1.1 if the UMA balance is lower than T(C) and 1 otherwise.</p>

<p>The peg-out fees for the peg-out transactions are paid from the UMA. If the UMA does not have enough funds, then the remaining funds are paid from the peg balance.</p>

<h2 id="rationale">Rationale</h2>

<h3 id="fixed-vs-variable-peg-out-fees">Fixed vs variable peg-out fees</h3>

<p>Having variable peg-out fees, together with batching, degrades the user experience, as the user does not have an immediate good estimation of the fees that the peg-out will collect. This proposal allows peg-out fees to vary according to a moving average that is updated on each peg-out event, but does not take into account the last event. Therefore the user should not expect fees to vary between querying the Bridge and performing the peg-out even if one peg-out event occurs in between.</p>

<p>The <code class="language-plaintext highlighter-rouge">getFeesForNextPegOutEvent()</code> fees are chosen to keep enough funds in the UMA to avoid consuming from the peg balance.</p>

<h3 id="magic-numbers">Magic Numbers</h3>

<p>The lower and upper bounds are chosen according to RSKIP265.</p>

<p>If there is no batching, then the number of UTXOs should be higher to avoid reaching the limit under normal operation. Assuming 450 UTXOs available, the peg can sustain a peg-out every 8 minutes continuously, which is a much higher rate that the current rate. While the values of B and C do not offer protection against a DoS attack, much higher values of B and C can lead to excessive CPU processing at peg-out time.</p>

<p>If we analyze this RSKIP together with <a href="https://github.com/rsksmart/RSKIPs/blob/master/IPs/RSKIP264.md">RSKIP264</a>, <a href="https://github.com/rsksmart/RSKIPs/blob/master/IPs/RSKIP270.md">RSKIP270</a> and <a href="https://github.com/rsksmart/RSKIPs/blob/master/IPs/RSKIP271.md">RSKIP271</a>, the choice of B and C enable to perform different UTXO management actions consuming the UMA balance, such as:</p>

<ul>
  <li>collect UMA fees for 60 inputs allows the Bridge to perform 15 consolidations when the UTXO set reaches 80 UTXO, removing up to 45 UTXOs from UTXO set.</li>
  <li>Assuming there are UTXO 60 in the Bridge, if the UMA is used to refresh emergency time-locks, then 100% of the UTXO will be able to be refreshed in the absence of peg-outs.</li>
  <li>If the UTXO expirations are uniformly distributed over the year, the current threshold allows all UTXOs for one year without peg-outs.</li>
  <li>The current threshold also allows to perform a full Powpeg migration.</li>
</ul>

<p>At current BTC/USD prices and with the current Powpeg multisig structure, the average balance of the UMA would be 800 USD.</p>

<h3 id="fee-estimation">Fee Estimation</h3>

<p>Weâ€™ve solved the problem of how users can estimate the peg-out transaction costs before the peg-out transaction is built. Now the Bridge computes the fees for wallets to show in their UIs. However, if two peg-out events occur after the query but before the peg-out command, the fees may have changed.</p>

<p>Itâ€™s also possible to provide a new version of the releaseBTC() method that supports an argument to indicate the maximum amount of fees that the user is willing to pay, and abort otherwise.</p>

<h3 id="utxo-management-account">UTXO Management Account</h3>

<p>The UMA serves as a fee buffer to smooth peg-out fees and also to pay for Bitcoin fees in exceptional events, such as forced UTXO consolidations or Powpeg migrations. In the future, it can also serve to provide an automatic fee bumping mechanism. The fees would be bumped automatically after 20 hours if a peg-out transaction containing a change output has not been informed to the Bridge.</p>

<h3 id="simulations">Simulations</h3>

<p><u>The algorithms and thresholds presented here need to be validated by simulations before the RSK community can approve this RSKIP. This section will show the simulation results. This RSKIP will be updated with improved algorithms and thresholds after simulations are completed.</u></p>

<h2 id="backwards-compatibility">Backwards Compatibility</h2>

<p>This change is a hard-fork and therefore all full nodes must be updated. SPV light-clients and Block explorers do not need to be updated.</p>

<h2 id="security-considerations">Security Considerations</h2>

<p>This RSKIP resolves an existing, but not critical, platform vulnerability.</p>

<h1 id="copyright"><strong>Copyright</strong></h1>

<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>

  </div>

</article>

      </div>
    </main><footer>
    <div class="footer_cont">
        <div class="footer_box">
            <ul class="social-media-list"><li><a href="https://github.com/rsksmart/RSKIPs" target="_blank" rel="noopener"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">Visit on Github</span></a></li></ul>
        </div>
    </div>
</footer><script src="../assets/js/dark_mode.js"></script>
    <script src="../../assets/js/dark_mode.js"></script>
  </body>

</html>
