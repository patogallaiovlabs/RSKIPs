<h1 id="fast-hibernation-wakeup-using-trie">Fast Hibernation Wakeup using Trie</h1>

<table>
  <thead>
    <tr>
      <th style="text-align: left">RSKIP</th>
      <th style="text-align: left">18</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left"><strong>Title</strong></td>
      <td style="text-align: left">Fast Hibernation Wakeup using Trie</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Created</strong></td>
      <td style="text-align: left">28-SEP-2016</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Author</strong></td>
      <td style="text-align: left">SDL</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Purpose</strong></td>
      <td style="text-align: left">Sca</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Layer</strong></td>
      <td style="text-align: left">Core</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Complexity</strong></td>
      <td style="text-align: left">2</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Status</strong></td>
      <td style="text-align: left">Draft</td>
    </tr>
  </tbody>
</table>

<h2 id="pre-git-revisions">Pre-git revisions</h2>

<p>Date: 29-09-2016</p>

<p>Revision: 1</p>

<p>Status: Draft (unfinished)</p>

<h1 id="abstract"><strong>Abstract</strong></h1>

<p>This RSKIP defines a mode of the opcode WAKEUP to wake up contracts consuming less gas.</p>

<h1 id="motivation"><strong>Motivation</strong></h1>

<p><a href="https://github.com/rsksmart/RSKIPs/blob/master/IPs/RSKIP17.md">RSKIP17</a> defines opcodes tailored to hibernate and wake up contracts (HIBERNATE and WAKEUP). That RSKIP proposes that when hibernation occurs, the hash of the persistent storage trie is hashed along the code hash and the resulting hash is persisted for later wake up. To wake up the hibernated contract, an RLP description of the trie must be given as WAKEUP argument. This requires the WAKEUP opcode to parse the RLP data and rebuild the tree. There are two problems with this approach:</p>

<ol>
  <li>
    <p>The cost of the WAKEUP opcode would depend on the complexity or size of the RLP data.</p>
  </li>
  <li>
    <p>Since contract volatile memory has a quadratic cost, filling the volatile memory with the RLP description may be very costly.</p>
  </li>
</ol>

<h2 id="discussion">Discussion</h2>

<p>To prevent using volatile memory, we can let the WAKEUP opcode specify that the persistent contract memory is copied on hibernation. Copying the whole persistent memory tree from one contract to another could be as fast as duplicating a node in the world state trie. Another solution is to change the protocol so that volatile memory cost is not quadratic, but linear.</p>

<h1 id="proposed-solution">Proposed solution</h1>

<p>When WAKEUP receives 0xff..ff (32 bytes) as the root trie, and zero length, as arguments, it means that the whole trie of storage must be moved from one contract to the contract that is woken up. Since memory is moved (not copied), it does not pay the SSTORE cost.</p>

<h1 id="specification"><strong>Specification</strong></h1>

<h3 id="wakeup">WAKEUP</h3>

<p>Arguments: contract_address code_address code_size trie_address trie_size</p>

<p>Value:</p>

<p>if trie_address is 0xffâ€¦0ff the cost is m*a+c</p>

<p>if trie_address is other, the cost is m*(a+b)+c,</p>

<p>Value accepted: 6 month of rent.</p>

<p>Returns: error_code</p>

<h1 id="copyright"><strong>Copyright</strong></h1>

<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
