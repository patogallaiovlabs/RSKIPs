<h1 id="bridge-peg-out-batching">Bridge peg-out Batching</h1>

<table>
  <thead>
    <tr>
      <th style="text-align: left"> </th>
      <th style="text-align: left">271</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left"><strong>Title</strong></td>
      <td style="text-align: left">Bridge peg-out batching</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Created</strong></td>
      <td style="text-align: left">AUG-2021</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Author</strong></td>
      <td style="text-align: left">SDL</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Purpose</strong></td>
      <td style="text-align: left">Sec, Usa</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Layer</strong></td>
      <td style="text-align: left">Core</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Complexity</strong></td>
      <td style="text-align: left">2</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Status</strong></td>
      <td style="text-align: left">Draft</td>
    </tr>
  </tbody>
</table>

<h1 id="abstract"><strong>Abstract</strong></h1>

<p>One of the problems of the RSK bridge is that the algorithm used for the creating of peg-out transactions is inefficient, because each peg-out request is served in a different Bitcoin transaction. This can lead to a number of cost, usability, efficiency and security problems. This RSKIP proposes a new algorithm for the Bridge to batch peg-out requests so a single Bitcoin transaction and a low number of UTXOs can serve a high number of peg-out requests.</p>

<h2 id="motivation">Motivation</h2>

<p>The current RSK bridge can suffer from a number of problems described in <a href="https://github.com/rsksmart/RSKIPs/blob/master/IPs/RSKIP265.md">RSKIP265</a>. In this RSKIP we’re mostly concerned with DoS attacks, and high peg-out costs. The proposed solution is to batch peg-outs.</p>

<h2 id="specification">Specification</h2>

<p>After receiving a peg-out request, and if no previous request is waiting in the queue, the Bridge contract will wait T=3 hours to create a peg-out transaction. During the waiting time, if more peg-out requests are received, they will be queued so that all of them can be batched in a single peg-out transaction. When the deadline is reached, a peg-out event will be triggered. Under normal usage, the Bridge would create no more than 8 peg-outs events a day. Under a rush hour of peg-outs, the Bridge may need to create more than one peg-out transaction simultaneously per peg-out event to reduce the transaction size, and input count. This peg-out splitting into transactions does not change from the current protocol.</p>

<h3 id="new-bridge-methods">New Bridge Methods</h3>

<ul>
  <li>
    <h4 id="peg-out-fees">Peg-out Fees</h4>
    <p>If <a href="https://github.com/rsksmart/RSKIPs/blob/master/IPs/RSKIP272.md">RSKIP272</a> is not activated, then the peg-out fees will be distributed evenly between all peg-out requests as it is today, and no change is required.</p>

    <p>A new Bridge method <code class="highlighter-rouge">getEstimatedFeesForNextPegOutEvent()</code>is created so that users can estimate the peg-out fees. This method returns the fees of a peg-out transaction containing (N+2) outputs and 2 inputs, where N is the number of peg-outs requests waiting in the queue. This method will be deprecated if RSKIP272 is activated.</p>
  </li>
  <li>
    <h4 id="peg-out-requests-count">Peg-out Requests Count</h4>
    <p>A new Bridge method <code class="highlighter-rouge">getQueuedPegoutsCount()</code> is created. This method returns the amount of peg-out requests waiting in the queue to be released in the next peg-out transaction.</p>
  </li>
  <li>
    <h4 id="peg-out-transaction-creation-block-number">Peg-out Transaction Creation Block Number</h4>
    <p>A new Bridge method <code class="highlighter-rouge">getNextPegoutCreationBlockNumber()</code> is created. This method returns the exact block number where the next peg-out transaction is expected to be created. This is calculated by adding the current block number (after a successful pegout) to a defined value of T=360 RSK blocks (~3 hours).</p>
  </li>
</ul>

<h3 id="new-bridge-event-for-batched-peg-out-transaction">New Bridge Event For Batched Peg-out Transaction</h3>
<p>A new event called <code class="highlighter-rouge">batch_pegout_created</code> is created for batched peg-out transaction.</p>

<p>Signature: <code class="highlighter-rouge">batch_pegout_created(bytes32 indexed btcTx, bytes releaseRskTxHashes)</code></p>

<h3 id="change-in-release_requested-event">Change in <code class="highlighter-rouge">release_requested</code> event</h3>
<p>Currently the RSK transaction hash for each peg-out request is used to emit <code class="highlighter-rouge">release_requested</code> event. An update for processing peg-out requests in batch would now use the RSK transaction hash of the transaction that calls updateCollections(at the time the next peg-out height is reached and a batch peg-out transaction is created) to emit <code class="highlighter-rouge">release_requested</code> event.</p>

<h2 id="rationale">Rationale</h2>

<p>The motives for this RSKIP are well explained in RSKIP265.</p>

<h2 id="backwards-compatibility">Backwards Compatibility</h2>

<p>This change is a hard-fork and therefore all full nodes must be updated. SPV light-clients and Block explorers do not need to be updated.</p>

<h2 id="security-considerations">Security Considerations</h2>

<p>This RSKIP resolves an existing, but not critical, platform vulnerability.</p>

<h1 id="copyright"><strong>Copyright</strong></h1>

<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
