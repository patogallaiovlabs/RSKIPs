<h1 id="memory-mapped-configuration-register">Memory-Mapped configuration register</h1>

<table>
  <thead>
    <tr>
      <th style="text-align: left">RSKIP</th>
      <th style="text-align: left">51</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left"><strong>Title</strong></td>
      <td style="text-align: left">Memory-Mapped configuration register</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Created</strong></td>
      <td style="text-align: left">10-DIC-2017</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Author</strong></td>
      <td style="text-align: left">SDL</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Purpose</strong></td>
      <td style="text-align: left">Usa</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Layer</strong></td>
      <td style="text-align: left">Core</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Complexity</strong></td>
      <td style="text-align: left">1</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Status</strong></td>
      <td style="text-align: left">Adopted</td>
    </tr>
  </tbody>
</table>

<h2 id="revisions">Revisions</h2>

<p>Revision: 2</p>

<p>Status: Draft</p>

<h1 id="abstract"><strong>Abstract</strong></h1>

<p>This RSKIP proposes to define a way to extend the EVM without compromising compatibility. A 32-byte memory-mapped configuration register is defined. The meaning of each bit of this register will be established in future RSKIPs.</p>

<h1 id="motivation"><strong>Motivation</strong></h1>

<p>The RVM (RSK VM) is based on the EVM. RSK intention is to maintain close to full compatibility with Ethereum’s VM. However, RSK has specific needs and its own roadmap for VM improvements. To extend the VM RSK defines new opcodes. However, to provide 100% compatibility with EVM, RSK defines two VM modes, selectable with a specific code header, as defined with <a href="https://github.com/rsksmart/RSKIPs/blob/master/IPs/RSKIP50.md">RSKIP50</a>. However the current standard EVM compilers are unable to generate code with this special headers, not allow user-defined opcodes in in-line assembly. It would be useful to be able to switch to new modes of operation and access new opcodes without patching the compilers.</p>

<p>There are several approaches to enable the extended mode:</p>

<ul>
  <li>
    <p>Redefine an existing opcode (e.g. CALL) so that when executed with specific parameters it works as a call into the “operating system” and enables access to internal RSK functions.</p>
  </li>
  <li>
    <p>Redefine a special uncommon opcode sequence as an enabler of a new working mode.</p>
  </li>
  <li>
    <p>Create a memory-mapped Configuration Register (COREG) that host a bit which enables the extended mode.</p>
  </li>
</ul>

<p>The memory mapped register is better because it allows mode changes with low gas cost, and won’t confuse static analyzers not interfere with code optimizers. The position of the COREG in memory is chosen that the probability that buggy code access this register by mistake is low. For instance, the position 0xff…ff is not good because a wrap-around zero of an array access would overwrite the COREG.</p>

<h1 id="specification"><strong>Specification</strong></h1>

<p>The COREG is a 32-byte wide register mapped at address 0x80…00. The register can be accessed by MSTORE, MLOAD and MLOAD8. Accesses with MSTORE/MLOAD should be aligned to the COREG starting offset. A mis-aligned MSTORE/MLOAD should rise an OOG exception. Code whould not be written assuming that a mis-aligned access rises an OOG because the COREG size may be extended in future hard-forks.</p>

<p>The cost of an MLOAD, MLOAD8 or MSTORE access to the COREG is exactly 3.</p>

<h1 id="copyright"><strong>Copyright</strong></h1>

<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
