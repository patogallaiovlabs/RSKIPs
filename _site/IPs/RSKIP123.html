<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>Multikey federation members | RSK Improvement Proposals</title>
    <meta
      property="og:title"
      content="Multikey federation members | RSK Improvement Proposals"
    />
    <meta name="description" content="RSK Improvement Proposals (RSKIPs) describe standards for the RSK platform, including core protocol specifications, client APIs, and contract standards." />
    <meta property="og:description" content="RSK Improvement Proposals (RSKIPs) describe standards for the RSK platform, including core protocol specifications, client APIs, and contract standards." />
    <meta name="twitter:description" content="RSK Improvement Proposals (RSKIPs) describe standards for the RSK platform, including core protocol specifications, client APIs, and contract standards." />

  <meta name="generator" content="Jekyll" />
  <meta property="og:locale" content="en_US" />
  <link rel="canonical" href="https://ips.rsk.co/IPs/RSKIP123" />
  <meta property="og:url" content="https://ips.rsk.co/IPs/RSKIP123" />
  <meta property="og:site_name" content="RSK Improvement Proposals" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@" />
  <script type="application/ld+json">
    {
      "@type": "WebSite",
      "url": "https://ips.rsk.co",
      "name": "RSK Improvement Proposals",
      "description": "RSK Improvement Proposals (RSKIPs) describe standards for the RSK platform, including core protocol specifications, client APIs, and contract standards.",
      "@context": "https://schema.org"
    }
  </script>
  <link rel="stylesheet" href="/assets/css/style.css" />
      <!-- Google Fonts -->
      <link href="https://fonts.googleapis.com/css?family=Quicksand:400,700,900&display=swap" rel="stylesheet">
      <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,600,700,800&display=swap" rel="stylesheet"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="RSK Improvement Proposals" /><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML" integrity="sha256-nlrDrBTHxJJlDDX22AS33xYI1OJHnGMDhiYMSe2U0e0=" crossorigin="anonymous"></script>
</head>
<body><header class="site-header" role="banner">
  <button id="dark-mode-toggle" class="dark-mode-toggle theme-toggle-button">
    <svg class="icon" style="width:24px;height:24px" viewBox="0 0 24 24">
      <path fill="currentColor" d="M7.5,2C5.71,3.15 4.5,5.18 4.5,7.5C4.5,9.82 5.71,11.85 7.53,13C4.46,13 2,10.54 2,7.5A5.5,5.5 0 0,1 7.5,2M19.07,3.5L20.5,4.93L4.93,20.5L3.5,19.07L19.07,3.5M12.89,5.93L11.41,5L9.97,6L10.39,4.3L9,3.24L10.75,3.12L11.33,1.47L12,3.1L13.73,3.13L12.38,4.26L12.89,5.93M9.59,9.54L8.43,8.81L7.31,9.59L7.65,8.27L6.56,7.44L7.92,7.35L8.37,6.06L8.88,7.33L10.24,7.36L9.19,8.23L9.59,9.54M19,13.5A5.5,5.5 0 0,1 13.5,19C12.28,19 11.15,18.6 10.24,17.93L17.93,10.24C18.6,11.15 19,12.28 19,13.5M14.6,20.08L17.37,18.93L17.13,22.28L14.6,20.08M18.93,17.38L20.08,14.61L22.28,17.15L18.93,17.38M20.08,12.42L18.94,9.64L22.28,9.88L20.08,12.42M9.63,18.93L12.4,20.08L9.87,22.27L9.63,18.93Z" />
    </svg>
  </button>


<div class="wrapper"><a class="site-title" rel="author" href="http://localhost:4000/">RSK Improvement Proposals</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link underline" href="http://localhost:4000/all">All</a><a class="page-link underline" href="http://localhost:4000/scalability">Scalability</a><a class="page-link underline" href="http://localhost:4000/security">Security</a><a class="page-link underline" href="http://localhost:4000/usability">Usability</a><a class="page-link underline" href="http://localhost:4000/fairness">Fairness</a><a class="page-link underline" href="http://localhost:4000/standardtrack">Standard Track</a></div>





      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post">

  <header class="post-header">
    <h1 class="post-title">Multikey federation members</h1>
  </header>

  <div class="post-content">
    <h1 id="multikey-federation-members">Multikey federation members</h1>

<table>
  <thead>
    <tr>
      <th style="text-align: left">RSKIP</th>
      <th style="text-align: left">123</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left"><strong>Title</strong></td>
      <td style="text-align: left">Multikey federation members</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Created</strong></td>
      <td style="text-align: left">28-May-19</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Author</strong></td>
      <td style="text-align: left">AM</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Purpose</strong></td>
      <td style="text-align: left">Sca,Sec</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Layer</strong></td>
      <td style="text-align: left">Core</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Complexity</strong></td>
      <td style="text-align: left">2</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>Status</strong></td>
      <td style="text-align: left">Draft</td>
    </tr>
  </tbody>
</table>

<h2 id="abstract">Abstract</h2>

<p>A network upgrade is introduced to enhance federation members with two additional keys. That is, each federation member will have three keys in total: one for Bitcoin transactions, one for RSK transactions and a last one, which we call MST, reserved for future use.</p>

<h2 id="motivation">Motivation</h2>

<p>The current state of the federation security model relies heavily on a Bitcoin multisignature wallet to protect pegged Bitcoin funds. Each federation member holds a distinct key to that multisignature wallet. The main problem lies in that this exact same key is also currently used by the federation members to sign every single RSK transaction they send to the Bridge contract – mandatory given that some Bridge methods are restricted only to federation members as an early protection against e.g. DoS attacks. This poses a big security risk in that a breach of a single key can compromise different aspects of the federation system, including loss of funds.</p>

<h2 id="specification">Specification</h2>

<p>At the time of writing, the <code class="language-plaintext highlighter-rouge">Bridge</code> contract works with a <code class="language-plaintext highlighter-rouge">Federation</code>, which is an abstraction for a set of distinct secp256k1 public keys, which can ultimately be used to represent a Bitcoin multisig (N of M) P2SH. To achieve this, the <code class="language-plaintext highlighter-rouge">Bridge</code> contract stores each federate member’s public key. The upgrade to this native contract involves replacing the set of public keys with a set of <code class="language-plaintext highlighter-rouge">FederationMember</code> objects, each of which will consist of three secp256k1 public keys (see subsection below). These keys will be assigned an individual role each, replacing the previous single multi purpose key model. In order to avoid a fork to the network as a consequence of the upgrade, each <code class="language-plaintext highlighter-rouge">FederationMember</code> will initially be constituted by three copies of the same previous multi-purpose key. The federate nodes that represent these federation members (by having control of the corresponding private keys) will also be upgraded in order to become multi-key aware, but in the same initial fashion. Therefore, even though both the <code class="language-plaintext highlighter-rouge">Bridge</code> contract and the federate nodes will be signing distinct transaction types with distinct keys, in practice these keys will initially remain the same and the system will operate as if unchanged. Only upon a federation change will distinct keys be specified, allowing for the upgrade to take full effect.</p>

<h3 id="key-set">Key set</h3>

<p>As already mentioned, each federation member will have control over three distinct keys. These are:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">BTC</code>: this key will be used solely for the signing of Bitcoin transactions related to the two-way peg. That is, this is the key that constitutes the multisig P2SH for the two-way peg. It is also the key that will be copied to the other two keys when the initial network upgrade takes place.</li>
  <li><code class="language-plaintext highlighter-rouge">RSK</code>: this key will be used solely for the signing of federation member RSK transactions. That is, every single transaction that needs to be authenticated by any smart contract (e.g., the <code class="language-plaintext highlighter-rouge">Bridge</code> native contract) as coming from a federation member will be signed using this key.</li>
  <li><code class="language-plaintext highlighter-rouge">MST</code>: this key will not have an immediate use. The idea is to have a distinct key to <code class="language-plaintext highlighter-rouge">BTC</code> and <code class="language-plaintext highlighter-rouge">RSK</code> that can potentially serve as a master key that can in turn be used to derive multiple distinct keys for purposes that require the federation’s authorization.</li>
</ul>

<h3 id="storage-upgrade">Storage upgrade</h3>

<p>In order to transition between single-key federation members to multi-key federation members without forking the network, a storage version approach was selected (see Rationale for a discussion). The read and write logic for a federation into the <code class="language-plaintext highlighter-rouge">Bridge</code> contract’s storage is as follows:</p>

<ul>
  <li>Writing: before the network upgrade, write the federation slot with the federation serialized using the legacy format (single-key per federation member); do not write the storage version slot. After the network upgrade, write the storage version slot with a version number chosen for the multi-key federation format, and then write the federation slot with the federation serialized using the multi-key format.</li>
  <li>Reading: read both the storage version slot and the federation slot. If storage version is empty, proceed the federation desserialization with the legacy federation format. Otherwise, desserialize the federation according to the version number read (which should correspond to the multi-key format).</li>
</ul>

<h3 id="bridge-methods-upgrade">Bridge methods upgrade</h3>

<p>Due to the change in the number of keys per federation member, some methods of the <code class="language-plaintext highlighter-rouge">Bridge</code> native contract need an upgrade, i.e., some methods are disabled in favor of new ones. To avoid mistaking old versions of methods with new versions of these methods, a design decision was made: new methods have different names than old ones. The list of disabled methods is the following:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">getFederatorPublicKey(int256) -&gt; bytes</code>.</li>
  <li><code class="language-plaintext highlighter-rouge">getPendingFederatorPublicKey(int256) -&gt; bytes</code></li>
  <li><code class="language-plaintext highlighter-rouge">getRetiringFederatorPublicKey(int256) -&gt; bytes</code></li>
  <li><code class="language-plaintext highlighter-rouge">addFederatorPublicKey(bytes) -&gt; int256</code></li>
</ul>

<p>For each disabled method there is a new corresponding multi-key version method that replaces it. These are, in order:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">getFederatorPublicKeyOfType(int256, string) -&gt; bytes</code>: given an index between <code class="language-plaintext highlighter-rouge">0</code> and <code class="language-plaintext highlighter-rouge">n-1</code>, where <code class="language-plaintext highlighter-rouge">n</code> is the total number of federation members in the currently active federation, and a string indicating the type of key to retrieve (one of the case-sensitive strings <code class="language-plaintext highlighter-rouge">btc</code>, <code class="language-plaintext highlighter-rouge">rsk</code> or <code class="language-plaintext highlighter-rouge">mst</code>), this method returns the compressed (Bitcoin, RSK or MST, respectively) public key for the currently active federation.</li>
  <li><code class="language-plaintext highlighter-rouge">getPendingFederatorPublicKeyOfType(int256, string) -&gt; bytes</code>: given an index between <code class="language-plaintext highlighter-rouge">0</code> and <code class="language-plaintext highlighter-rouge">n-1</code>, where <code class="language-plaintext highlighter-rouge">n</code> is the total number of federation members in the currently pending federation, and a string indicating the type of key to retrieve (one of the case-sensitive strings <code class="language-plaintext highlighter-rouge">btc</code>, <code class="language-plaintext highlighter-rouge">rsk</code> or <code class="language-plaintext highlighter-rouge">mst</code>), this method returns the compressed (Bitcoin, RSK or MST, respectively) public key for the currently pending federation, if any.</li>
  <li><code class="language-plaintext highlighter-rouge">getRetiringFederatorPublicKeyOfType(int256, string) -&gt; bytes</code>: given an index between <code class="language-plaintext highlighter-rouge">0</code> and <code class="language-plaintext highlighter-rouge">n-1</code>, where <code class="language-plaintext highlighter-rouge">n</code> is the total number of federation members in the currently retiring federation, and a string indicating the type of key to retrieve (one of the case-sensitive strings <code class="language-plaintext highlighter-rouge">btc</code>, <code class="language-plaintext highlighter-rouge">rsk</code> or <code class="language-plaintext highlighter-rouge">mst</code>), this method returns the compressed (Bitcoin, RSK or MST, respectively) public key for the currently retiring federation, if any.</li>
  <li><code class="language-plaintext highlighter-rouge">addFederatorPublicKeyMultikey(bytes, bytes, bytes) -&gt; int256</code>: given three secp256k1 public keys corresponding to Bitcoin, RSK and MST keys, this method adds a new federation member with those keys to the currently pending federation and returns <code class="language-plaintext highlighter-rouge">1</code> to indicate success. If no pending federation currently exists, <code class="language-plaintext highlighter-rouge">-1</code> is returned. If any member of the currently pending federation has a match in any of the corresponding new keys, <code class="language-plaintext highlighter-rouge">-2</code> is returned.</li>
</ul>

<h2 id="rationale">Rationale</h2>

<p>When deciding upon the implementation of this network upgrade, one of the main issues discussed was how to handle the storage upgrade. There were essentially two possible approaches:</p>

<ul>
  <li><strong>Version-based storage reads, block number based writes</strong>. This is the approach that was ultimately agreed on. It is both simple and flexible in that is allows for the actual storage upgrade (i.e., the new format writes) to happen at any point after the designated network upgrade block number is reached.</li>
  <li><strong>Transaction induced storage upgrade</strong>. This approach consisted on an automatic transaction (in the style of the REMASC transactions) being triggered once exactly on the designated network upgrade block number. This transaction would simply update the corresponding storage with the new format. Then, the format for reads and writes from and to storage from the <code class="language-plaintext highlighter-rouge">Bridge</code> contract itself would only rely on the current block number. Given the complexity associated with triggering the “upgrade transaction”, this approach was ultimately discarded.</li>
</ul>

<h3 id="copyright">Copyright</h3>

<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>

  </div>

</article>

      </div>
    </main><footer>
    <div class="footer_cont">
        <div class="footer_box">
            <ul class="social-media-list"><li><a href="https://github.com/rsksmart/RSKIPs" target="_blank" rel="noopener"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">Visit on Github</span></a></li></ul>
        </div>
    </div>
</footer><script src="../assets/js/dark_mode.js"></script>
    <script src="../../assets/js/dark_mode.js"></script>
  </body>

</html>
